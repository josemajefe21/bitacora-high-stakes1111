<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4ade80">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bit√°cora">
  <title>Bit√°cora High Stakes v3.0 - Cloud Only</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- PWA Meta Tags -->
  <meta name="description" content="Bit√°cora para seguimiento de cultivos">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <!-- Configuraci√≥n de Firebase -->
  <script src="firebase-config.js"></script>
  <!-- Fuente divertida tipo cartoon -->
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4ade80;
      --secondary-color: #0ea5e9;
      --background-color: #f3f4f6;
      --text-color: #111827;
    }

    body {
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--background-color) 80%, #d1fae5 100%);
      padding: 20px;
      color: var(--text-color);
      min-height: 100vh;
      position: relative;
    }
    h1 {
      font-family: 'Luckiest Guy', cursive;
      font-size: 2.1em;
      margin-bottom: 10px;
      letter-spacing: 1px;
      color: #388e3c;
      text-shadow: 2px 2px 0 #fff, 0 2px 8px #a7f3d0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    h1::before {
      content: 'üå±';
      font-size: 1.2em;
      margin-right: 8px;
      -webkit-filter: drop-shadow(0 2px 2px #a7f3d0);
      filter: drop-shadow(0 2px 2px #a7f3d0);
    }
    h2 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 10px;
      letter-spacing: 1px;
      text-shadow: 1px 1px 0 #fff, 0 1px 4px #a7f3d0;
    }
    label {
      font-weight: bold;
      color: #388e3c;
      letter-spacing: 0.5px;
    }
    textarea, input[type="text"], input[type="date"] {
      width: 100%;
      margin: 5px 0 12px 0;
      padding: 10px;
      font-size: 15px;
      border-radius: 12px;
      border: 2.5px solid #a7f3d0;
      background: #f0fdf4;
      box-shadow: 0 2px 8px rgba(167, 243, 208, 0.33);
      transition: border 0.2s, box-shadow 0.2s;
    }
    textarea:focus, input[type="text"]:focus, input[type="date"]:focus {
      border: 2.5px solid #4ade80;
      box-shadow: 0 4px 16px rgba(74, 222, 128, 0.33);
      outline: none;
    }
    button {
      margin: 5px 8px 5px 0;
      padding: 8px 14px;
      font-size: 15px;
      border: none;
      border-radius: 10px 18px 10px 18px;
      background-color: #4ade80;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(167, 243, 208, 0.67);
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
      transition: transform 0.1s, box-shadow 0.2s;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: 0 1px 4px rgba(167, 243, 208, 0.33);
    }
    .stage-btn {
      padding: 8px 10px;
      margin: 4px;
      font-size: 15px;
      border: 2.5px solid transparent;
      border-radius: 12px 20px 12px 20px;
      background-color: #e5e7eb;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
    }
    .stage-selected {
      border-color: #0ea5e9;
      background-color: #bae6fd;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.33);
    }
    .button-small {
      padding: 6px 10px;
      font-size: 13px;
      background-color: #0ea5e9;
      border-radius: 10px 18px 10px 18px;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
    }
    .mood-btn {
      display: inline-block;
      margin-right: 10px;
      padding: 10px 14px;
      border: 2.5px solid transparent;
      border-radius: 16px 24px 16px 24px;
      cursor: pointer;
      font-size: 18px;
      background: #e0f2fe;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .mood-selected {
      border-color: #0ea5e9;
      background-color: #e0f2fe;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.33);
    }
    .entry {
      background: #fff;
      padding: 16px 14px 16px 24px;
      margin-bottom: 16px;
      border-radius: 24px 32px 24px 32px;
      box-shadow: 0 4px 24px rgba(167, 243, 208, 0.67), 0 1.5px 0 #4ade80;
      border-left: 8px solid #4ade80;
      position: relative;
      overflow: hidden;
    }
    .entry::before {
      content: 'üåø';
      position: absolute;
      left: 8px;
      top: -10px;
      font-size: 1.5em;
      opacity: 0.25;
      transform: rotate(-20deg);
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 12px;
      max-width: 240px;
      background: #e0f2fe;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
      padding: 10px 5px;
    }
    .day {
      width: 32px;
      height: 32px;
      border-radius: 10px 16px 10px 16px;
      text-align: center;
      font-size: 12px;
      line-height: 32px;
      background-color: #e5e7eb;
      color: #000;
      box-shadow: 0 1px 4px rgba(167, 243, 208, 0.33);
      border: 1.5px solid #a7f3d0;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .m1 { background-color: #f87171; }
    .m2 { background-color: #facc15; }
    .m3 { background-color: #4ade80; }
    .m4 { background-color: #22c55e; }
    /* Detalles de hojas en el fondo */
    body::after {
      content: 'üå±üåø';
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 2.5em;
      opacity: 0.13;
      pointer-events: none;
      z-index: 0;
    }
    /* --- INICIO: Estilos responsivos para m√≥vil --- */
    @media (max-width: 600px) {
      body {
        padding: 8px;
        font-size: 15px;
      }
      h1 {
        font-size: 1.3em;
        text-align: center;
      }
      h2 {
        font-size: 1.1em;
      }
      .calendar {
        max-width: 100%;
        gap: 2px;
        padding: 6px 2px;
      }
      .day {
        width: 22px;
        height: 22px;
        font-size: 8px;
        line-height: 22px;
      }
      .entry {
        padding: 10px 7px 10px 14px;
        font-size: 13px;
        border-radius: 16px 20px 16px 20px;
      }
      button, .stage-btn, .button-small {
        font-size: 13px;
        padding: 8px 8px;
        margin: 4px 4px 4px 0;
        border-radius: 10px 16px 10px 16px;
      }
      .mood-btn {
        font-size: 15px;
        padding: 7px 10px;
        margin-right: 5px;
        border-radius: 12px 18px 12px 18px;
      }
      textarea, input[type="text"], input[type="date"] {
        font-size: 13px;
        padding: 7px;
        border-radius: 10px;
      }
      #calendarVisual {
        overflow-x: auto;
      }
      
      /* Estilos responsivos para campos de cepas y luces */
      .bitacora-form-row {
        flex-direction: column;
        gap: 8px;
      }
      
      .bitacora-form-row input[type="text"] {
        flex: 1;
        min-width: 0;
        width: 100%;
      }
      
      .bitacora-form-row input[type="number"] {
        width: 80px;
        min-width: 80px;
      }
      
      .cepa-item, .carpa-item, .luz-item {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        padding: 8px;
      }
      
      .cepa-item input[type="number"], 
      .carpa-item input[type="number"] {
        width: 100%;
        margin-left: 0;
        margin-top: 4px;
      }
      
      .cepa-remove, .carpa-remove, .luz-remove {
        align-self: flex-end;
        margin-left: 0;
        margin-top: 4px;
      }
      
      /* Mejorar el layout de los campos de formulario */
      .bitacora-form-group {
        margin-bottom: 1.5rem;
      }
      
      .bitacora-form-group input[type="text"],
      .bitacora-form-group input[type="number"],
      .bitacora-form-group select {
        font-size: 16px; /* Evita zoom en iOS */
        padding: 12px;
        border-radius: 8px;
      }
      
      /* Hacer los botones m√°s grandes en m√≥vil */
      .bitacora-form-group button,
      .bitacora-form-row button {
        padding: 12px 16px;
        font-size: 16px;
        border-radius: 8px;
        min-height: 44px; /* Tama√±o m√≠nimo para touch */
      }
    }
    /* --- FIN: Estilos responsivos para m√≥vil --- */

    /* Estilos para el modal de edici√≥n */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin: 50px auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      right: 10px;
      top: 10px;
      cursor: pointer;
      font-size: 24px;
    }

    /* Estilos para el historial */
    .history-entry {
      position: relative;
    }

    .edit-button {
      position: absolute;
      right: 10px;
      top: 10px;
      background: var(--secondary-color);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Actualizar estilos del selector de bit√°coras */
    .bitacora-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 10px;
      background: #f8fafc;
      border-radius: 12px;
    }

    .bitacora-card {
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      font-weight: bold;
      min-width: 120px;
      text-align: center;
      position: relative;
    }

    .bitacora-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .bitacora-card:hover .bitacora-actions {
      opacity: 1;
    }

    .action-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: transform 0.2s;
    }

    .action-btn:hover {
      transform: scale(1.1);
    }

    .edit-btn { color: #0ea5e9; }
    .delete-btn { color: #f87171; }
    .share-btn { color: #4ade80; }

    /* Modal de edici√≥n de bit√°cora */
    .edit-bitacora-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .edit-bitacora-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      margin: 50px auto;
      position: relative;
    }

    .visibility-selector {
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .visibility-selector label {
      font-weight: bold;
      color: #374151;
    }

    .visibility-selector select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background-color: white;
      color: #374151;
      font-size: 14px;
    }

    .visibility-indicator {
      margin-left: 8px;
      font-size: 14px;
      opacity: 0.8;
    }

    .bitacora-card .visibility-indicator {
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 12px;
      opacity: 0.8;
    }

    .new-bitacora {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
    }

    .new-bitacora.active {
      display: block;
    }

    .new-bitacora input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }

    .color-picker {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: #000;
      transform: scale(1.1);
    }

    .new-bitacora button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 10px;
    }



    .credits {
      font-family: 'Quicksand', sans-serif;
      font-size: 0.9em;
      color: #4b5563;
      text-align: center;
      margin-top: -5px;
      margin-bottom: 20px;
      font-style: italic;
    }

    .help-question {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 12px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .help-question:hover {
      background: rgba(255, 255, 255, 1);
    }

    .bitacora-form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .bitacora-form-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .bitacora-form-group label {
      font-weight: 600;
      color: #388e3c;
    }
    .bitacora-form-group input[type="text"],
    .bitacora-form-group input[type="number"],
    .bitacora-form-group select {
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: 'Quicksand', sans-serif;
    }
    .bitacora-form-group input[type="text"]:focus,
    .bitacora-form-group input[type="number"]:focus,
    .bitacora-form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .bitacora-form-group button,
    .bitacora-form-row button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background-color: var(--primary-color);
      color: white;
      transition: all 0.2s;
    }
    .bitacora-form-group button:hover,
    .bitacora-form-row button:hover {
      background-color: var(--secondary-color);
    }
    .bitacora-form-group input[type="checkbox"] {
      accent-color: var(--primary-color);
      width: 1.1em;
      height: 1.1em;
    }
    .cepa-item, .carpa-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 6px 10px;
      margin-bottom: 4px;
    }
    .cepa-item input[type="number"], .carpa-item input[type="number"] {
      width: 60px;
      margin-left: 4px;
    }
    .cepa-remove, .carpa-remove {
      background: #f87171;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0 10px;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 6px;
    }
    .cepa-remove:hover, .carpa-remove:hover {
      background: #ef4444;
    }
    .bitacora-form-checkboxes label {
      margin-right: 16px;
      font-weight: 500;
      color: #388e3c;
    }
    .luz-btn {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      font-size: 1.5rem;
      padding: 0.5rem 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      color: #388e3c;
    }
    .luz-btn.selected, .luz-btn:active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .luz-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 6px 10px;
      margin-bottom: 4px;
    }
    .luz-remove {
      background: #f87171;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0 10px;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 6px;
    }
    .luz-remove:hover {
      background: #ef4444;
    }

    /* Estilos para mostrar caracter√≠sticas de la bit√°cora */
    .bitacora-info {
      background: #fff;
      padding: 20px;
      border-radius: 16px 24px 16px 24px;
      box-shadow: 0 4px 24px rgba(167, 243, 208, 0.67), 0 1.5px 0 #4ade80;
      border-left: 8px solid #4ade80;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .bitacora-info::before {
      content: 'üìã';
      position: absolute;
      left: 8px;
      top: -10px;
      font-size: 1.5em;
      opacity: 0.25;
      transform: rotate(-20deg);
    }

    .bitacora-info h3 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 15px;
      text-shadow: 1px 1px 0 #fff, 0 1px 4px #a7f3d0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .info-section {
      background: #f8fafc;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .info-section h4 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 8px;
      font-size: 0.9em;
      text-shadow: 1px 1px 0 #fff;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9em;
    }

    .info-value {
      color: #6b7280;
      font-size: 0.9em;
      text-align: right;
    }

    .info-value.cepa {
      background: #4ade80;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.luz {
      background: #facc15;
      color: #374151;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.riego {
      background: #0ea5e9;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.interior {
      background: #a78bfa;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.exterior {
      background: #22c55e;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.invernadero {
      background: #f472b6;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .no-info {
      color: #9ca3af;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* Responsive para m√≥vil */
    @media (max-width: 600px) {
      .info-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .bitacora-info {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .info-section {
        padding: 10px;
      }
    }

    /* Estilos para el sistema de autenticaci√≥n */
    .auth-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f3f4f6 80%, #d1fae5 100%);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .auth-container.active {
      display: flex;
    }

    .auth-card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .auth-card::before {
      content: 'üå±';
      position: absolute;
      top: -15px;
      left: 20px;
      font-size: 3em;
      opacity: 0.1;
      transform: rotate(-15deg);
    }

    .auth-card h2 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 20px;
      font-size: 1.8em;
      text-shadow: 1px 1px 0 #fff, 0 1px 4px #a7f3d0;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .auth-form input {
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Quicksand', sans-serif;
      transition: all 0.3s;
    }

    .auth-form input:focus {
      outline: none;
      border-color: #4ade80;
      box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
    }

    .auth-btn {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Quicksand', sans-serif;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(74, 222, 128, 0.3);
    }

    .auth-btn:active {
      transform: translateY(0);
    }

    .auth-btn.secondary {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
    }

    .auth-btn.secondary:hover {
      box-shadow: 0 5px 15px rgba(14, 165, 233, 0.3);
    }

    .auth-switch {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }

    .auth-switch a {
      color: #4ade80;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-switch a:hover {
      text-decoration: underline;
    }

    .user-info {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 10px 15px;
      border-radius: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 100;
      font-family: 'Quicksand', sans-serif;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .user-details {
      display: flex;
      flex-direction: column;
    }

    .user-email {
      font-size: 12px;
      color: #6b7280;
    }

    .user-name {
      font-weight: 600;
      color: #374151;
    }

    .logout-btn {
      background: #f87171;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #ef4444;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4ade80;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .success-message {
      background: #f0fdf4;
      color: #16a34a;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bbf7d0;
      margin-bottom: 15px;
      font-size: 14px;
    }

    /* Responsive para m√≥vil */
    @media (max-width: 600px) {
      .auth-card {
        margin: 20px;
        padding: 20px;
      }
      
      .user-info {
        top: 10px;
        left: 10px;
        right: 10px;
        padding: 8px 12px;
      }
    }

    .extractor-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 6px 10px;
      margin-bottom: 4px;
    }
    
    .extractor-remove {
      background: #f87171;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0 10px;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 6px;
    }
    
    .extractor-remove:hover {
      background: #ef4444;
    }

    body.dark-mode {
      background: #18181b !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode label, body.dark-mode .info-label {
      color: #a7f3d0 !important;
      border-color: #4ade80 !important;
      text-shadow: none !important;
    }
    body.dark-mode .entry, body.dark-mode .bitacora-info, body.dark-mode .info-section, body.dark-mode .auth-card, body.dark-mode .user-info, body.dark-mode .modal-content, body.dark-mode .edit-bitacora-content, body.dark-mode .backup-modal-content, body.dark-mode .new-bitacora, body.dark-mode .bitacora-selector, body.dark-mode .calendar, body.dark-mode .day, body.dark-mode .credits {
      background: #22223b !important;
      color: #f3f4f6 !important;
      box-shadow: 0 4px 24px rgba(30,41,59,0.67), 0 1.5px 0 #4ade80;
    }
    body.dark-mode .bitacora-card {
      background: #334155 !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode .bitacora-card.active {
      border-color: #facc15 !important;
    }
    body.dark-mode .calendar, body.dark-mode .day {
      background: #22223b !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode .m1 { background-color: #b91c1c !important; }
    body.dark-mode .m2 { background-color: #ca8a04 !important; }
    body.dark-mode .m3 { background-color: #16a34a !important; }
    body.dark-mode .m4 { background-color: #166534 !important; }
    body.dark-mode button, body.dark-mode .stage-btn, body.dark-mode .button-small {
      background: #334155 !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode button:hover, body.dark-mode .stage-btn:hover, body.dark-mode .button-small:hover {
      background: #4ade80 !important;
      color: #18181b !important;
    }
    body.dark-mode .modal {
      background: rgba(24,24,27,0.85) !important;
    }
    body.dark-mode input, body.dark-mode textarea, body.dark-mode select {
      background: #18181b !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode input::placeholder, body.dark-mode textarea::placeholder {
      color: #a7f3d0 !important;
      opacity: 0.7;
    }
    body.dark-mode .extractor-item, body.dark-mode .cepa-item, body.dark-mode .carpa-item, body.dark-mode .luz-item {
      background: #334155 !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode .error-message {
      background: #7f1d1d !important;
      color: #fca5a5 !important;
      border-color: #f87171 !important;
    }
    body.dark-mode .success-message {
      background: #14532d !important;
      color: #bbf7d0 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode .color-option {
      border-color: #4ade80 !important;
    }
    body.dark-mode .color-option.selected {
      border-color: #facc15 !important;
    }
    body.dark-mode .auth-switch a {
      color: #4ade80 !important;
    }
    body.dark-mode .user-avatar {
      background: linear-gradient(135deg, #334155, #4ade80) !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode .logout-btn {
      background: #b91c1c !important;
      color: #fff !important;
    }
    body.dark-mode .logout-btn:hover {
      background: #ef4444 !important;
      color: #fff !important;
    }
    body.dark-mode .help-question {
      background: #334155 !important;
      color: #f3f4f6 !important;
      border: 2px solid #4ade80 !important;
    }
    body.dark-mode .modal-content, body.dark-mode .edit-bitacora-content {
      background: #18181b !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode .info-value {
      color: #bbf7d0 !important;
    }
    body.dark-mode .info-value.cepa {
      background: #16a34a !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.luz {
      background: #facc15 !important;
      color: #22223b !important;
    }
    body.dark-mode .info-value.riego {
      background: #0ea5e9 !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.interior {
      background: #a78bfa !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.exterior {
      background: #22c55e !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.invernadero {
      background: #f472b6 !important;
      color: #fff !important;
    }
    body.dark-mode .no-info {
      color: #a7f3d0 !important;
    }
  </style>
</head>
<body>
  <!-- Sistema de Autenticaci√≥n -->
  <div class="auth-container" id="authContainer">
    <!-- Login Form -->
    <div class="auth-card" id="loginCard">
      <h2>üå± Iniciar Sesi√≥n</h2>
      <form class="auth-form" id="loginForm">
        <div id="loginError" class="error-message" style="display: none;"></div>
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Contrase√±a" required>
        <button type="submit" class="auth-btn" id="loginBtn">
          <span id="loginBtnText">Iniciar Sesi√≥n</span>
          <span id="loginBtnLoading" class="loading" style="display: none;"></span>
        </button>
      </form>
      <div class="auth-switch">
        <a onclick="showRegister()">¬øNo tienes cuenta? Reg√≠strate</a>
      </div>
    </div>

    <!-- Register Form -->
    <div class="auth-card" id="registerCard" style="display: none;">
      <h2>üå± Crear Cuenta</h2>
      <form class="auth-form" id="registerForm">
        <div id="registerError" class="error-message" style="display: none;"></div>
        <input type="text" id="registerName" placeholder="Nombre completo" required>
        <input type="email" id="registerEmail" placeholder="Email" required>
        <input type="password" id="registerPassword" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minlength="6">
        <input type="password" id="registerConfirmPassword" placeholder="Confirmar contrase√±a" required>
        <button type="submit" class="auth-btn" id="registerBtn">
          <span id="registerBtnText">Crear Cuenta</span>
          <span id="registerBtnLoading" class="loading" style="display: none;"></span>
        </button>
      </form>
      <div class="auth-switch">
        <a onclick="showLogin()">¬øYa tienes cuenta? Inicia sesi√≥n</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header-bar" style="display: flex; align-items: center; gap: 16px; justify-content: flex-end; flex-wrap: wrap;">
      <!-- Informaci√≥n del Usuario -->
      <div class="user-info" id="userInfo" style="display: none; margin-left: 10px;">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-details">
          <div class="user-name" id="userName">Usuario</div>
          <div class="user-email" id="userEmail">usuario@email.com</div>
        </div>
        <button class="logout-btn" onclick="logout()">Cerrar</button>
      </div>
    </div>
    
    <h1>Bit√°cora High Stakes üå±</h1>
    <div class="credits">Creada por Smart Honey Selections</div>

    <!-- Selector de Bit√°coras -->
    <div class="bitacora-selector" id="bitacoraSelector">
      <!-- Las bit√°coras se generar√°n din√°micamente -->
    </div>

    <!-- Formulario para nueva bit√°cora -->
    <div class="new-bitacora" id="newBitacoraForm" style="display:none; position:relative;">
      <button class="close-modal" style="position:absolute; right:10px; top:10px; font-size:1.7em; background:none; border:none; color:#888; z-index:10;" onclick="toggleNewBitacoraForm()">&times;</button>
      <h3>Nueva Bit√°cora</h3>
      <div class="bitacora-form-group">
        <input type="text" id="newBitacoraName" placeholder="Nombre de la bit√°cora" />
        <div class="color-picker" id="colorPicker">
          <!-- Los colores se generar√°n din√°micamente como c√≠rculos -->
        </div>
      </div>
      <!-- Cepas -->
      <div class="bitacora-form-group">
        <label>Cepas:</label>
        <div id="cepasList"></div>
        <div class="bitacora-form-row">
          <input type="text" id="cepaNombre" placeholder="Nombre de la cepa" />
          <input type="number" id="cepaCantidad" placeholder="Cantidad" min="1" value="1" />
          <select id="cepaTipo" onchange="toggleGerminacionField()">
            <option value="clon">Clon</option>
            <option value="semilla">Semilla</option>
          </select>
          <button type="button" onclick="addCepa()">+</button>
        </div>
        <div id="semillaFields" style="display:none;">
          <input type="date" id="cepaGerminacion" placeholder="D√≠a de germinaci√≥n" />
        </div>
      </div>
      <!-- Tipo de cultivo -->
      <div class="bitacora-form-group">
        <label>Tipo de cultivo:</label>
        <select id="tipoCultivo" onchange="toggleInteriorFields()">
          <option value="">Selecciona...</option>
          <option value="interior">Interior</option>
          <option value="exterior">Exterior</option>
          <option value="invernadero">Invernadero</option>
        </select>
      </div>
      <div id="interiorFields" style="display:none;">
        <div class="bitacora-form-group">
          <label>¬øCu√°ntas carpas?</label>
          <input type="number" id="numCarpas" min="0" value="0" onchange="toggleCarpasFields()" />
          <label><input type="checkbox" id="soloSala" onchange="toggleCarpasFields()" /> Solo una sala</label>
          <div id="carpasList"></div>
        </div>
        <div class="bitacora-form-group">
          <label>L√°mparas de vegetaci√≥n:</label>
          <input type="number" id="lamparasVege" min="0" value="0" />
          <input type="text" id="wattsVege" placeholder="Watts totales / por l√°mpara" />
        </div>
        <div class="bitacora-form-group">
          <label>L√°mparas de floraci√≥n:</label>
          <input type="number" id="lamparasFlora" min="0" value="0" />
          <input type="text" id="wattsFlora" placeholder="Watts totales / por l√°mpara" />
        </div>
        <div class="bitacora-form-group">
          <label>Ventiladores:</label>
          <input type="number" id="ventiladores" min="0" value="0" />
          <input type="text" id="pulgadasVentilador" placeholder="Pulgadas (opcional)" />
        </div>
        <div class="bitacora-form-group">
          <label>Extractores:</label>
          <div id="extractoresList"></div>
          <div class="bitacora-form-row">
            <input type="number" id="extractorCantidad" placeholder="Cantidad" min="1" value="1" />
            <input type="text" id="extractorPulgadas" placeholder="Pulgadas" />
            <button type="button" onclick="addExtractor()">+</button>
          </div>
        </div>
        <div class="bitacora-form-group">
          <label>Filtro de aire:</label>
          <select id="filtroAire">
            <option value="no">No</option>
            <option value="si">S√≠</option>
          </select>
        </div>
        <div class="bitacora-form-group">
          <label>Aire acondicionado:</label>
          <select id="aireAcondicionado" onchange="toggleFrigorias()">
            <option value="no">No</option>
            <option value="si">S√≠</option>
          </select>
          <input type="text" id="frigorias" placeholder="Frigor√≠as" style="display:none;" />
        </div>
      </div>
      <!-- Tipo de riego -->
      <div class="bitacora-form-group bitacora-form-checkboxes">
        <label>Tipo de riego:</label>
        <div id="riegoOptions">
          <label><input type="checkbox" value="manual" /> Manual</label>
          <label><input type="checkbox" value="goteo" /> Goteo</label>
          <label><input type="checkbox" value="hidroponica" /> Hidrop√≥nica</label>
        </div>
        <input type="text" id="detalleRiego" placeholder="Detalles de riego (opcional)" />
      </div>
      <!-- Sustrato -->
      <div class="bitacora-form-group">
        <label>Sustrato:</label>
        <input type="text" id="sustrato" placeholder="Especifica el sustrato (opcional)" />
      </div>
      <!-- Tipo de luz -->
      <div class="bitacora-form-group">
        <label>Tipo de luz:</label>
        <div id="luzOptions" style="display: flex; gap: 12px; margin-bottom: 8px;">
          <button type="button" class="luz-btn" id="luzSolBtn" onclick="selectLuz('sol')">‚òÄÔ∏è Sol</button>
          <button type="button" class="luz-btn" id="luzArtificialBtn" onclick="selectLuz('luz')">üí° Luz</button>
          <button type="button" class="luz-btn" id="luzMixtoBtn" onclick="selectLuz('mixto')">üîÑ Mixto</button>
        </div>
        <div id="luzSolIcon" style="display:none; font-size:2rem; margin-bottom:8px;">‚òÄÔ∏è</div>
        <div id="luzArtificialFields" style="display:none;">
          <label>Agregar luces:</label>
          <div id="lucesList"></div>
          <div class="bitacora-form-row">
            <input type="text" id="luzNombre" placeholder="Nombre de la luz" />
            <input type="number" id="luzCantidad" placeholder="Cantidad" min="1" value="1" />
            <input type="number" id="luzWatts" placeholder="Watts" min="1" />
            <button type="button" onclick="addLuz()">+</button>
          </div>
        </div>
      </div>
      <button onclick="createNewBitacora()">Crear Bit√°cora</button>
    </div>

    <!-- Contenido principal (se mostrar√° solo cuando haya una bit√°cora seleccionada) -->
    <div id="mainContent" style="display: none;">
      <!-- Etapas -->
      <label>Etapa:</label><br/>
      <div>
        <button class="stage-btn" id="btn-vege" onclick="setStage('vege')">üü¢ Vegetativo</button>
        <button class="stage-btn" id="btn-flora" onclick="setStage('flora')">üå∫ Floraci√≥n</button>
        <button class="stage-btn" id="btn-general" onclick="setStage('general')">üìñ General</button>
        <button class="stage-btn" id="btn-problems" onclick="setStage('problems')">üö® Problemas</button>
      </div>

      <!-- Resumen Semanal -->
      <div class="weekly-summary" id="weeklySummary">
        <h3>Resumen Semanal</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <h4>Total Entradas</h4>
            <div id="totalEntries">0</div>
          </div>
          <div class="summary-item">
            <h4>Promedio Emocional</h4>
            <div id="averageMood">-</div>
          </div>
          <div class="summary-item">
            <h4>D√≠as con Riego</h4>
            <div id="wateredDays">0</div>
          </div>
        </div>
        <div class="emotion-timeline" id="emotionTimeline">
          <!-- La l√≠nea de tiempo se generar√° din√°micamente -->
        </div>
        
        <!-- Resumen IA -->
        <div class="ai-summary" id="aiSummary" style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border-left: 4px solid #0ea5e9;">
          <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 1.2em;">ü§ñ</span>
            <h4 style="margin: 0 0 0 8px; color: #0369a1;">An√°lisis Semanal IA</h4>
            <button onclick="regenerateAISummary()" style="margin-left: auto; padding: 4px 8px; font-size: 0.8em; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ Regenerar</button>
          </div>
          <div id="aiSummaryContent" style="color: #1e40af; line-height: 1.6;">
            <!-- El contenido se generar√° autom√°ticamente -->
          </div>
        </div>
      </div>

      <!-- Caracter√≠sticas de la Bit√°cora (se mostrar√° solo en la secci√≥n general) -->
      <div class="bitacora-info" id="bitacoraInfo" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3>üìã Caracter√≠sticas de la Bit√°cora</h3>
          <button onclick="editCurrentBitacora()" class="button-small" style="background: #3b82f6; color: white; border-color: #3b82f6;">
            ‚úèÔ∏è Editar Bit√°cora
          </button>
        </div>
        <div id="bitacoraInfoContent">
          <!-- El contenido se generar√° din√°micamente -->
        </div>
      </div>

      <!-- Secci√≥n de Gesti√≥n de Problemas (se mostrar√° solo en la secci√≥n problemas) -->
      <div class="problems-section" id="problemsSection" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3>üö® Gesti√≥n de Problemas</h3>
          <button onclick="addNewProblemFromSection()" class="button-small" style="background: #ef4444; color: white; border-color: #ef4444;">
            ‚ûï Nuevo Problema
          </button>
        </div>
        
        <!-- Estad√≠sticas r√°pidas -->
        <div class="problems-stats-section" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
          <div class="stat-card" style="background: #f0fdf4; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;" id="problemsActiveSection">0</div>
            <div style="font-size: 0.9em; color: #16a34a;">Activos</div>
          </div>
          <div class="stat-card" style="background: #fef2f2; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 1.5em; font-weight: bold; color: #ef4444;" id="problemsCriticalSection">0</div>
            <div style="font-size: 0.9em; color: #dc2626;">Cr√≠ticos</div>
          </div>
          <div class="stat-card" style="background: #f0f9ff; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 1.5em; font-weight: bold; color: #0ea5e9;" id="problemsResolvedSection">0</div>
            <div style="font-size: 0.9em; color: #0284c7;">Resueltos</div>
          </div>
          <div class="stat-card" style="background: #fffbeb; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 1.5em; font-weight: bold; color: #f59e0b;" id="avgResolutionTimeSection">0h</div>
            <div style="font-size: 0.9em; color: #d97706;">Tiempo Promedio</div>
          </div>
        </div>

        <!-- Filtros -->
        <div class="problems-filters-section" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
          <select id="filterStatusSection" onchange="filterProblemsSection()" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-size: 0.9em;">
            <option value="all">Todos los estados</option>
            <option value="reported">üìù Reportados</option>
            <option value="in-progress">‚è≥ En Proceso</option>
            <option value="resolved">‚úÖ Resueltos</option>
            <option value="unresolved">‚ùå No Resueltos</option>
          </select>
          <select id="filterSeveritySection" onchange="filterProblemsSection()" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-size: 0.9em;">
            <option value="all">Todas las gravedades</option>
            <option value="high">üî¥ Cr√≠ticos</option>
            <option value="moderate">üü† Moderados</option>
            <option value="low">üü° Leves</option>
            <option value="info">üü¢ Informativos</option>
          </select>
          <select id="filterCategorySection" onchange="filterProblemsSection()" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-size: 0.9em;">
            <option value="all">Todas las categor√≠as</option>
            <option value="pest">üêõ Plagas</option>
            <option value="nutrition">üå± Nutrici√≥n</option>
            <option value="watering">üíß Riego</option>
            <option value="environment">üå°Ô∏è Ambiente</option>
            <option value="growth">üìè Crecimiento</option>
            <option value="other">‚ùì Otro</option>
          </select>
        </div>

        <!-- Lista de problemas -->
        <div class="problems-list-section" id="problemsListSection" style="max-height: 500px; overflow-y: auto; padding-right: 5px;">
          <!-- Los problemas se generar√°n din√°micamente -->
        </div>
      </div>

      <div id="floraStartContainer" style="display:none;">
        <label>Inicio de floraci√≥n:</label>
        <input type="date" id="floraStart" onchange="setFloraStart()" />
      </div>

      <!-- Formulario de entrada -->
      <div id="entryForm">
        <label>Fecha del registro:</label>
        <input type="date" id="date" onfocus="this.showPicker()" />

        <label>¬øC√≥mo estuvo el d√≠a?</label><br/>
        <div id="moodOptions"></div>

        <label>Tareas realizadas:</label>
        <textarea id="tasks"></textarea>

        <label>¬øRegaste hoy?</label><br/>
        <button onclick="setWater(true)">üíß S√≠</button>
        <button onclick="setWater(false)">‚ùå No</button><br/>

        <div id="waterDetails" style="display:none;">
          <input type="text" id="waterAmount" placeholder="Cantidad de agua (L o ml)" />
          <input type="text" id="nutrients" placeholder="Nutrientes utilizados" />
          <input type="text" id="ph" placeholder="pH del agua" />
          <input type="text" id="ec" placeholder="EC del agua" />
        </div>

        <label>Problemas o anomal√≠as:</label>
        <textarea id="issues"></textarea>

        <label>Notas o reflexiones:</label>
        <textarea id="notes"></textarea>

        <button onclick="saveEntry()">Guardar entrada</button>
        <button class="button-small" onclick="exportData()">üì§ Exportar JSON</button>
      </div>

      <!-- Historial -->
      <h2>Historial</h2>
      <div id="calendarVisual"></div>
      <div id="history"></div>
    </div>

    <!-- Modal de edici√≥n -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h3>Editar Entrada</h3>
        <input type="password" id="editPassword" placeholder="Contrase√±a" onkeypress="if(event.key==='Enter') verifyEditPassword()" />
        <button onclick="verifyEditPassword()" style="margin: 10px 0; background: #22c55e;">Verificar Contrase√±a</button>
        <div id="editForm" style="display: none;">
          <!-- El formulario de edici√≥n se generar√° din√°micamente -->
        </div>
      </div>
    </div>

    <!-- Agregar el modal de edici√≥n de bit√°cora -->
    <div class="edit-bitacora-modal" id="editBitacoraModal">
      <div class="edit-bitacora-content">
        <span class="close-modal" onclick="closeEditBitacoraModal()">&times;</span>
        <h3>Editar Bit√°cora</h3>
        <input type="text" id="editBitacoraName" placeholder="Nombre de la bit√°cora" />
        <div class="color-picker" id="editColorPicker">
          <!-- Los colores se generar√°n din√°micamente -->
        </div>
        <!-- Cepas -->
        <label>Cepas:</label>
        <div id="editCepasList"></div>
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
          <input type="text" id="editCepaNombre" placeholder="Nombre de la cepa" style="flex:2;" />
          <input type="number" id="editCepaCantidad" placeholder="Cantidad" min="1" value="1" style="width:70px;" />
          <select id="editCepaTipo" onchange="toggleEditGerminacionField()">
            <option value="clon">Clon</option>
            <option value="semilla">Semilla</option>
          </select>
          <button type="button" onclick="addEditCepa()">+</button>
        </div>
        <div id="editSemillaFields" style="display:none; margin-bottom:10px;">
          <input type="date" id="editCepaGerminacion" placeholder="D√≠a de germinaci√≥n" />
        </div>
        <!-- Tipo de cultivo -->
        <label>Tipo de cultivo:</label>
        <select id="editTipoCultivo" onchange="toggleEditInteriorFields()">
          <option value="">Selecciona...</option>
          <option value="interior">Interior</option>
          <option value="exterior">Exterior</option>
          <option value="invernadero">Invernadero</option>
        </select>
        <div id="editInteriorFields" style="display:none; margin-top:10px;">
          <label>¬øCu√°ntas carpas?</label>
          <input type="number" id="editNumCarpas" min="0" value="0" style="width:70px;" onchange="toggleEditCarpasFields()" />
          <label><input type="checkbox" id="editSoloSala" onchange="toggleEditCarpasFields()" /> Solo una sala</label>
          <div id="editCarpasList" style="margin-bottom:10px;"></div>
          <!-- L√°mparas -->
          <label>L√°mparas de vegetaci√≥n:</label>
          <input type="number" id="editLamparasVege" min="0" value="0" style="width:70px;" />
          <input type="text" id="editWattsVege" placeholder="Watts totales / por l√°mpara" />
          <label>L√°mparas de floraci√≥n:</label>
          <input type="number" id="editLamparasFlora" min="0" value="0" style="width:70px;" />
          <input type="text" id="editWattsFlora" placeholder="Watts totales / por l√°mpara" />
          <!-- Ventiladores -->
          <label>Ventiladores:</label>
          <input type="number" id="editVentiladores" min="0" value="0" style="width:70px;" />
          <input type="text" id="editPulgadasVentilador" placeholder="Pulgadas (opcional)" />
          <!-- Extractores -->
          <label>Extractores:</label>
          <div id="editExtractoresList"></div>
          <div style="display: flex; gap: 8px; margin-bottom: 10px;">
            <input type="number" id="editExtractorCantidad" placeholder="Cantidad" min="1" value="1" style="width:70px;" />
            <input type="text" id="editExtractorPulgadas" placeholder="Pulgadas" />
            <button type="button" onclick="addEditExtractor()">+</button>
          </div>
          <!-- Filtro de aire -->
          <label>Filtro de aire:</label>
          <select id="editFiltroAire">
            <option value="no">No</option>
            <option value="si">S√≠</option>
          </select>
          <!-- Aire acondicionado -->
          <label>Aire acondicionado:</label>
          <select id="editAireAcondicionado" onchange="toggleEditFrigorias()">
            <option value="no">No</option>
            <option value="si">S√≠</option>
          </select>
          <input type="text" id="editFrigorias" placeholder="Frigor√≠as" style="display:none;" />
        </div>
        <!-- Tipo de riego -->
        <label>Tipo de riego:</label>
        <div id="editRiegoOptions">
          <label><input type="checkbox" value="manual" /> Manual</label>
          <label><input type="checkbox" value="goteo" /> Goteo</label>
          <label><input type="checkbox" value="hidroponica" /> Hidrop√≥nica</label>
        </div>
        <input type="text" id="editDetalleRiego" placeholder="Detalles de riego (opcional)" />
        <!-- Sustrato -->
        <label>Sustrato:</label>
        <input type="text" id="editSustrato" placeholder="Especifica el sustrato (opcional)" />
        <div class="visibility-selector">
          <label>Visibilidad:</label>
          <select id="editBitacoraVisibility">
            <option value="false">Privada</option>
            <option value="true">P√∫blica</option>
          </select>
        </div>
        <button onclick="saveBitacoraEdit()">Guardar Cambios</button>
      </div>
    </div>



    <!-- Modal de Gesti√≥n de Problemas -->
    <div class="modal" id="problemsModal" style="display:none;">
      <div class="modal-content" style="max-width: 800px; margin: 20px auto;">
        <span class="close-modal" onclick="closeProblemsModal()">&times;</span>
        <h2 style="font-family: 'Luckiest Guy', cursive; color: #388e3c;">üö® Gesti√≥n de Problemas</h2>
        
        <!-- Estad√≠sticas r√°pidas -->
        <div class="problems-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
          <div class="stat-card" style="background: #f0fdf4; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;" id="problemsActive">0</div>
            <div style="font-size: 0.9em; color: #16a34a;">Activos</div>
          </div>
          <div class="stat-card" style="background: #fef2f2; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5em; font-weight: bold; color: #ef4444;" id="problemsCritical">0</div>
            <div style="font-size: 0.9em; color: #dc2626;">Cr√≠ticos</div>
          </div>
          <div class="stat-card" style="background: #f0f9ff; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5em; font-weight: bold; color: #0ea5e9;" id="problemsResolved">0</div>
            <div style="font-size: 0.9em; color: #0284c7;">Resueltos</div>
          </div>
          <div class="stat-card" style="background: #fffbeb; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5em; font-weight: bold; color: #f59e0b;" id="avgResolutionTime">0h</div>
            <div style="font-size: 0.9em; color: #d97706;">Tiempo Promedio</div>
          </div>
        </div>

        <!-- Formulario para nuevo problema -->
        <div class="new-problem-form" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3>‚ûï Reportar Nuevo Problema</h3>
          <div style="display: grid; grid-template-columns: 1fr 150px 150px; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="newProblemTitle" placeholder="Describe el problema..." style="padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb;">
            <select id="newProblemSeverity" style="padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb;">
              <option value="low">üü° Leve</option>
              <option value="moderate">üü† Moderado</option>
              <option value="high">üî¥ Cr√≠tico</option>
              <option value="info">üü¢ Informativo</option>
            </select>
            <select id="newProblemCategory" style="padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb;">
              <option value="pest">üêõ Plagas</option>
              <option value="nutrition">üå± Nutrici√≥n</option>
              <option value="watering">üíß Riego</option>
              <option value="environment">üå°Ô∏è Ambiente</option>
              <option value="growth">üìè Crecimiento</option>
              <option value="other">‚ùì Otro</option>
            </select>
          </div>
          <div style="display: flex; gap: 10px;">
            <textarea id="newProblemDescription" placeholder="Descripci√≥n detallada (opcional)..." style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; min-height: 60px;"></textarea>
            <button onclick="addNewProblem()" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">
              Reportar
            </button>
          </div>
        </div>

        <!-- Filtros -->
        <div class="problems-filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
          <select id="filterStatus" onchange="filterProblems()" style="padding: 6px; border-radius: 4px; border: 1px solid #e5e7eb;">
            <option value="all">Todos los estados</option>
            <option value="reported">üìù Reportados</option>
            <option value="in-progress">‚è≥ En Proceso</option>
            <option value="resolved">‚úÖ Resueltos</option>
            <option value="unresolved">‚ùå No Resueltos</option>
          </select>
          <select id="filterSeverity" onchange="filterProblems()" style="padding: 6px; border-radius: 4px; border: 1px solid #e5e7eb;">
            <option value="all">Todas las gravedades</option>
            <option value="high">üî¥ Cr√≠ticos</option>
            <option value="moderate">üü† Moderados</option>
            <option value="low">üü° Leves</option>
            <option value="info">üü¢ Informativos</option>
          </select>
          <select id="filterCategory" onchange="filterProblems()" style="padding: 6px; border-radius: 4px; border: 1px solid #e5e7eb;">
            <option value="all">Todas las categor√≠as</option>
            <option value="pest">üêõ Plagas</option>
            <option value="nutrition">üå± Nutrici√≥n</option>
            <option value="watering">üíß Riego</option>
            <option value="environment">üå°Ô∏è Ambiente</option>
            <option value="growth">üìè Crecimiento</option>
            <option value="other">‚ùì Otro</option>
          </select>
        </div>

        <!-- Lista de problemas -->
        <div class="problems-list" id="problemsList" style="max-height: 400px; overflow-y: auto;">
          <!-- Los problemas se generar√°n din√°micamente -->
        </div>
      </div>
    </div>

    <!-- Modal para editar problema -->
    <div class="modal" id="editProblemModal" style="display:none;">
      <div class="modal-content" style="max-width: 500px; margin: 50px auto;">
        <span class="close-modal" onclick="closeEditProblemModal()">&times;</span>
        <h3>‚úèÔ∏è Editar Problema</h3>
        <div style="margin-bottom: 15px;">
          <label>Estado:</label>
          <select id="editProblemStatus" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; margin-top: 5px;">
            <option value="reported">üìù Reportado</option>
            <option value="in-progress">‚è≥ En Proceso</option>
            <option value="resolved">‚úÖ Resuelto</option>
            <option value="unresolved">‚ùå No Resuelto</option>
          </select>
        </div>
        <div style="margin-bottom: 15px;">
          <label>Gravedad:</label>
          <select id="editProblemSeverity" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; margin-top: 5px;">
            <option value="low">üü° Leve</option>
            <option value="moderate">üü† Moderado</option>
            <option value="high">üî¥ Cr√≠tico</option>
            <option value="info">üü¢ Informativo</option>
          </select>
        </div>
        <div style="margin-bottom: 15px;">
          <label>Soluci√≥n aplicada:</label>
          <textarea id="editProblemSolution" placeholder="Describe la soluci√≥n aplicada..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; margin-top: 5px; min-height: 80px;"></textarea>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeEditProblemModal()" style="background: #6b7280; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">
            Cancelar
          </button>
          <button onclick="saveProblemEdit()" style="background: #22c55e; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de ayuda -->
    <div class="modal" id="helpModal" style="display:none;">
      <div class="modal-content" style="max-width: 400px; margin: 50px auto; background: #fff; border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: relative;">
        <span class="close-modal" onclick="closeHelpModal()" style="position: absolute; right: 1rem; top: 1rem; cursor: pointer; font-size: 1.5rem;">&times;</span>
        <h2 style="font-family: 'Luckiest Guy', cursive; color: #388e3c;">¬øQu√© puede hacer Bit√°cora High Stakes?</h2>
        <ul style="font-size: 1.1rem; color: #374151; margin-top: 1rem; list-style: none; padding-left: 0;">
          <li><span style='font-size:1.3em; margin-right:6px;'>üå±</span>Gestiona varios cultivos en un solo lugar.</li>
          <li><span style='font-size:1.3em; margin-right:6px;'>üìä</span>Visualiza tu progreso con gr√°ficos autom√°ticos de emociones, riego y par√°metros del agua.</li>
  
          <li><span style='font-size:1.3em; margin-right:6px;'>üîí</span>Comparte tus bit√°coras o mantenlas privadas seg√∫n prefieras.</li>
          <li><span style='font-size:1.3em; margin-right:6px;'>üì±</span>Accede desde cualquier dispositivo, incluso sin conexi√≥n (PWA).</li>
          <li><span style='font-size:1.3em; margin-right:6px;'>üì§</span>Exporta tus registros para llevar un control fuera de la app.</li>
        </ul>
        <div style="margin-top: 1.5rem; text-align: center; color: #4ade80; font-family: 'Luckiest Guy', cursive;">¬°Tu cultivo, tu historia! üåø</div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales del sistema de autenticaci√≥n
    let currentUser = null;
    let isAuthenticated = false;

    // Registrar el Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registrado:', registration);
          })
          .catch(error => {
            console.log('Error al registrar ServiceWorker:', error);
          });
      });
    }

    // Manejar la instalaci√≥n de la PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Variables globales
    let selectedBitacora = null;
    let selectedMood = null;
    let selectedStage = 'vege';
    let didWater = false;
    let tipoLuz = '';
    let luces = [];
    let extractores = [];

    const moodStates = [
      { value: 1, icon: 'üòû', label: 'Mal d√≠a', color: '#f87171' },
      { value: 2, icon: '‚ö†Ô∏è', label: 'Regular', color: '#facc15' },
      { value: 3, icon: 'üåø', label: 'Bueno', color: '#4ade80' },
      { value: 4, icon: 'üåû', label: 'Muy bueno', color: '#22c55e' }
    ];

    const availableColors = [
      '#4ade80', '#0ea5e9', '#f87171', '#facc15',
      '#a78bfa', '#f472b6', '#60a5fa', '#34d399'
    ];

    // ===== SISTEMA DE PROTECCI√ìN DE DATOS INTEGRADO =====
    console.log("üõ°Ô∏è Activando protecciones integradas...");

    // Guardado antes de cerrar p√°gina
    window.addEventListener('beforeunload', function(e) {
      try {
        if (userBitacoras && userBitacoras.length > 0) {
          localStorage.setItem('bitacoras', JSON.stringify(userBitacoras));
          localStorage.setItem('emergency_backup_on_exit', JSON.stringify({
            timestamp: new Date().toISOString(),
            userBitacoras: userBitacoras,
            selectedBitacora: selectedBitacora,
            message: 'Guardado autom√°tico al cerrar p√°gina'
          }));
          console.log("‚úÖ Respaldo de emergencia creado al cerrar");
        }
      } catch (error) {
        console.error("Error en guardado de emergencia:", error);
      }
    });

    // Auto-guardado cada 30 segundos
    setInterval(() => {
      if (userBitacoras && userBitacoras.length > 0) {
        try {
          localStorage.setItem('bitacoras', JSON.stringify(userBitacoras));
          localStorage.setItem(`auto_save_${Date.now()}`, JSON.stringify({
            timestamp: new Date().toISOString(),
            userBitacoras: userBitacoras,
            type: 'continuous_auto_save'
          }));
          
          if (currentUser && selectedBitacora) {
            saveBitacoraToFirestore(selectedBitacora).catch(error => {
              console.error("Error en auto-guardado Firebase:", error);
            });
          }
          
          console.log("üîÑ Auto-guardado completado:", new Date().toLocaleTimeString());
          
          // Limpiar respaldos antiguos
          const autoSaveKeys = Object.keys(localStorage).filter(key => key.startsWith('auto_save_'));
          if (autoSaveKeys.length > 20) {
            autoSaveKeys.sort();
            for (let i = 0; i < autoSaveKeys.length - 20; i++) {
              localStorage.removeItem(autoSaveKeys[i]);
            }
          }
        } catch (error) {
          console.error("Error en auto-guardado:", error);
        }
      }
    }, 30000);

    // Funci√≥n de restauraci√≥n de emergencia
    window.emergencyRestore = function() {
      console.log("üöë RESTAURACI√ìN DE EMERGENCIA...");
      const backupKeys = Object.keys(localStorage).filter(key => 
        key.includes('backup') || key.includes('auto_save') || key.startsWith('before_') || key.startsWith('after_')
      );
      
      if (backupKeys.length === 0) {
        alert("No se encontraron respaldos");
        return;
      }
      
      const backups = backupKeys.map(key => {
        try {
          const data = JSON.parse(localStorage.getItem(key));
          return { key, timestamp: data.timestamp, data };
        } catch {
          return null;
        }
      }).filter(Boolean);
      
      backups.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      console.log(`üì¶ Encontrados ${backups.length} respaldos`);
      const latest = backups[0];
      if (latest.data.userBitacoras) {
        userBitacoras = latest.data.userBitacoras;
        renderBitacoraSelector();
        if (userBitacoras.length > 0) {
          selectBitacora(userBitacoras[0].id);
        }
        alert(`‚úÖ Datos restaurados desde ${latest.timestamp}`);
      }
    };

    console.log("‚úÖ PROTECCIONES INTEGRADAS ACTIVADAS");

    // ===== FUNCI√ìN DE GUARDADO AUTOM√ÅTICO =====
    async function autoSave() {
      if (!currentUser || !selectedBitacora) return;
      
      try {
        await saveBitacoraToFirestore(selectedBitacora);
        console.log('Guardado autom√°tico completado');
      } catch (error) {
        console.error('Error en guardado autom√°tico:', error);
      }
    }

    // ===== SISTEMA DE AUTENTICACI√ìN =====

    // Observar cambios en el estado de autenticaci√≥n
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Usuario autenticado
        currentUser = user;
        isAuthenticated = true;
        showUserInfo(user);
        hideAuthContainer();
        loadUserData();
      } else {
        // Usuario no autenticado
        currentUser = null;
        isAuthenticated = false;
        hideUserInfo();
        showAuthContainer();
        clearUserData();
      }
    });

    // Funciones de autenticaci√≥n
    function showAuthContainer() {
      document.getElementById('authContainer').classList.add('active');
      document.querySelector('.container').style.display = 'none';
    }

    function hideAuthContainer() {
      document.getElementById('authContainer').classList.remove('active');
      document.querySelector('.container').style.display = 'block';
    }

    function showUserInfo(user) {
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');

      // Mostrar informaci√≥n del usuario
      userInfo.style.display = 'flex';
      
      // Avatar con iniciales
      const displayName = user.displayName || user.email.split('@')[0];
      userAvatar.textContent = displayName.charAt(0).toUpperCase();
      
      // Nombre y email
      userName.textContent = displayName;
      userEmail.textContent = user.email;
    }

    function hideUserInfo() {
      document.getElementById('userInfo').style.display = 'none';
    }

    function showLogin() {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('registerCard').style.display = 'none';
      clearAuthErrors();
    }

    function showRegister() {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('registerCard').style.display = 'block';
      clearAuthErrors();
    }

    function clearAuthErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const loginBtnText = document.getElementById('loginBtnText');
      const loginBtnLoading = document.getElementById('loginBtnLoading');
      const loginError = document.getElementById('loginError');

      // Mostrar loading
      loginBtn.disabled = true;
      loginBtnText.style.display = 'none';
      loginBtnLoading.style.display = 'inline-block';
      loginError.style.display = 'none';

      try {
        await auth.signInWithEmailAndPassword(email, password);
        // El onAuthStateChanged se encargar√° del resto
      } catch (error) {
        console.error('Error de login:', error);
        loginError.textContent = getErrorMessage(error.code);
        loginError.style.display = 'block';
      } finally {
        // Ocultar loading
        loginBtn.disabled = false;
        loginBtnText.style.display = 'inline';
        loginBtnLoading.style.display = 'none';
      }
    });

    // Registro
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;
      const registerBtn = document.getElementById('registerBtn');
      const registerBtnText = document.getElementById('registerBtnText');
      const registerBtnLoading = document.getElementById('registerBtnLoading');
      const registerError = document.getElementById('registerError');

      // Validar contrase√±as
      if (password !== confirmPassword) {
        registerError.textContent = 'Las contrase√±as no coinciden';
        registerError.style.display = 'block';
        return;
      }

      // Mostrar loading
      registerBtn.disabled = true;
      registerBtnText.style.display = 'none';
      registerBtnLoading.style.display = 'inline-block';
      registerError.style.display = 'none';

      try {
        // Crear usuario
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        // Actualizar perfil
        await userCredential.user.updateProfile({
          displayName: name
        });

        // Crear documento de usuario en Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Migrar datos locales si existen
        await migrateLocalData(userCredential.user.uid);

      } catch (error) {
        console.error('Error de registro:', error);
        registerError.textContent = getErrorMessage(error.code);
        registerError.style.display = 'block';
      } finally {
        // Ocultar loading
        registerBtn.disabled = false;
        registerBtnText.style.display = 'inline';
        registerBtnLoading.style.display = 'none';
      }
    });

    // Logout
    async function logout() {
      try {
        await auth.signOut();
        // El onAuthStateChanged se encargar√° del resto
      } catch (error) {
        console.error('Error de logout:', error);
        alert('Error al cerrar sesi√≥n');
      }
    }

    // Obtener mensaje de error amigable
    function getErrorMessage(errorCode) {
      const errorMessages = {
        'auth/user-not-found': 'No existe una cuenta con este email',
        'auth/wrong-password': 'Contrase√±a incorrecta',
        'auth/email-already-in-use': 'Este email ya est√° registrado',
        'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres',
        'auth/invalid-email': 'Email inv√°lido',
        'auth/too-many-requests': 'Demasiados intentos. Intenta m√°s tarde',
        'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet'
      };
      return errorMessages[errorCode] || 'Error desconocido. Intenta de nuevo';
    }

    // ===== GESTI√ìN DE DATOS CON FIRESTORE =====

    // Cargar datos del usuario
    async function loadUserData() {
      if (!currentUser) return;

      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
          // Actualizar √∫ltimo login
          await db.collection('users').doc(currentUser.uid).update({
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Cargar bit√°coras del usuario
        await loadUserBitacoras();
        
      } catch (error) {
        console.error('Error al cargar datos del usuario:', error);
      }
    }

    // Variable global para almacenar bit√°coras en memoria
    let userBitacoras = [];

    // Cargar bit√°coras del usuario
    async function loadUserBitacoras() {
      if (!currentUser) return;

      try {
        console.log('Cargando bit√°coras del usuario:', currentUser.uid);
        const bitacorasSnapshot = await db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').get();

        userBitacoras = [];
        bitacorasSnapshot.forEach(doc => {
          userBitacoras.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log('Bit√°coras cargadas desde Firebase:', userBitacoras.length);
        
        // Renderizar selector de bit√°coras
        renderBitacoraSelector();
        
        // Seleccionar primera bit√°cora si existe
        if (userBitacoras.length > 0) {
          selectBitacora(userBitacoras[0].id);
        } else {
          showNewBitacoraForm();
        }

      } catch (error) {
        console.error('Error al cargar bit√°coras:', error);
        alert('Error al cargar bit√°coras. Verifica tu conexi√≥n a internet.');
      }
    }

    // Guardar bit√°cora en Firestore
    async function saveBitacoraToFirestore(bitacora) {
      if (!currentUser) return;

      try {
        const bitacoraRef = db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').doc(bitacora.id);
        
        await bitacoraRef.set({
          ...bitacora,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log('Bit√°cora guardada en Firestore');
      } catch (error) {
        console.error('Error al guardar bit√°cora:', error);
        throw error;
      }
    }

    // Migrar datos locales a Firestore
    async function migrateLocalData(userId) {
      try {
        const localBitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        
        if (localBitacoras.length > 0) {
          const batch = db.batch();
          
          for (const bitacora of localBitacoras) {
            const bitacoraRef = db.collection('users').doc(userId)
              .collection('bitacoras').doc(bitacora.id);
            
            batch.set(bitacoraRef, {
              ...bitacora,
              migratedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          await batch.commit();
          console.log('Datos migrados exitosamente');
        }
      } catch (error) {
        console.error('Error al migrar datos:', error);
      }
    }

    // Limpiar datos del usuario
    function clearUserData() {
      userBitacoras = [];
      selectedBitacora = null;
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('bitacoraSelector').innerHTML = '';
    }

    // ===== FUNCIONES MODIFICADAS PARA FIRESTORE =====

    // Modificar createNewBitacora para usar Firestore
    async function createNewBitacora() {
      if (!currentUser) {
        alert('Debes iniciar sesi√≥n para crear una bit√°cora');
        return;
      }

      const name = document.getElementById('newBitacoraName').value.trim();
      const selectedColor = document.querySelector('.color-option.selected');
      
      if (!name) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }

      const color = selectedColor.style.backgroundColor;
      
      // Verificar si ya existe una bit√°cora con ese nombre
      if (userBitacoras.some(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
        return;
      }

      // Recopilar caracter√≠sticas (c√≥digo existente)
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const lamparasVege = parseInt(document.getElementById('lamparasVege').value) || 0;
      const wattsVege = document.getElementById('wattsVege').value;
      const lamparasFlora = parseInt(document.getElementById('lamparasFlora').value) || 0;
      const wattsFlora = document.getElementById('wattsFlora').value;
      const ventiladores = parseInt(document.getElementById('ventiladores').value) || 0;
      const pulgadasVentilador = document.getElementById('pulgadasVentilador').value;
      const filtroAire = document.getElementById('filtroAire').value;
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias').value;
      
      // Recopilar carpas con metros cuadrados
      const carpas = [];
      document.querySelectorAll('#carpasList .carpa-item input[type="number"]').forEach(input => {
        if (input.value) {
          carpas.push({ metrosCuadrados: parseFloat(input.value) });
        }
      });
      
      const riegoOptions = [];
      document.querySelectorAll('#riegoOptions input[type=checkbox]:checked').forEach(cb => {
        riegoOptions.push(cb.value);
      });
      const detalleRiego = document.getElementById('detalleRiego').value;
      const sustrato = document.getElementById('sustrato').value;

      const newBitacora = {
        id: Date.now().toString(),
        name,
        color,
        floraStart: null,
        isPublic: true,
        userId: currentUser.uid,
        // Caracter√≠sticas de la bit√°cora
        cepas: [...cepas],
        tipoCultivo,
        numCarpas,
        soloSala,
        carpas: carpas,
        lamparasVege,
        wattsVege,
        lamparasFlora,
        wattsFlora,
        ventiladores,
        pulgadasVentilador,
        extractores: [...extractores],
        filtroAire,
        aireAcondicionado,
        frigorias,
        riegoOptions,
        detalleRiego,
        sustrato,
        tipoLuz,
        luces: [...luces],
        entries: {
          vege: [],
          flora: [],
          general: []
        },
        createdAt: new Date().toISOString()
      };

      try {
        // Guardar en Firestore
        console.log('Guardando nueva bit√°cora en Firebase:', newBitacora.name);
        await saveBitacoraToFirestore(newBitacora);
        console.log('Bit√°cora guardada exitosamente en Firebase');
        
        // Actualizar array en memoria
        userBitacoras.push(newBitacora);
        console.log('Bit√°cora agregada a memoria, total:', userBitacoras.length);
        
        // Limpiar formulario
        document.getElementById('newBitacoraName').value = '';
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('newBitacoraForm').classList.remove('active');
        
        // Limpiar variables globales
        cepas = [];
        extractores = [];
        luces = [];
        tipoLuz = '';
        
        // Actualizar UI
        renderBitacoraSelector();
        selectBitacora(newBitacora.id);
        
      } catch (error) {
        console.error('Error al crear bit√°cora:', error);
        alert('Error al crear la bit√°cora. Intenta de nuevo.');
      }
    }

    // Modificar saveEntry para usar Firestore
    async function saveEntry() {
      if (!selectedBitacora || !currentUser) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }

      const date = document.getElementById('date').value;
      if (!date || !selectedMood) {
        alert('Eleg√≠ fecha y estado emocional.');
        return;
      }

      const entry = {
        date,
        mood: selectedMood,
        tasks: document.getElementById('tasks').value,
        issues: document.getElementById('issues').value,
        notes: document.getElementById('notes').value,
        didWater,
        waterAmount: document.getElementById('waterAmount').value,
        nutrients: document.getElementById('nutrients').value,
        ph: document.getElementById('ph').value,
        ec: document.getElementById('ec').value,
        createdAt: new Date().toISOString()
      };

      try {
        // Actualizar en memoria
        const bitacoraIndex = userBitacoras.findIndex(b => b.id === selectedBitacora.id);
        
        if (bitacoraIndex !== -1) {
          let entries = userBitacoras[bitacoraIndex].entries[selectedStage].filter(e => e.date !== date);
          entries.push(entry);
          userBitacoras[bitacoraIndex].entries[selectedStage] = entries;
          
          selectedBitacora = userBitacoras[bitacoraIndex];
          
          // Guardar en Firestore
          await saveBitacoraToFirestore(selectedBitacora);
          
          // Actualizar UI
          renderHistory();
          renderCalendar();
          updateWeeklySummary();
        }
      } catch (error) {
        console.error('Error al guardar entrada:', error);
        alert('Error al guardar la entrada. Intenta de nuevo.');
      }
    }

    // Funciones auxiliares
    function getEntries() {
      if (!selectedBitacora) return [];
      return selectedBitacora.entries[selectedStage] || [];
    }

    function updateWeeklySummary() {
      if (!selectedBitacora) return;

      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());

      let weekEntries = [];
      
      // En la secci√≥n general, combinar entradas de todas las etapas SIN DUPLICADOS
      if (selectedStage === 'general') {
        const allEntries = [];
        if (selectedBitacora.entries.vege) allEntries.push(...selectedBitacora.entries.vege);
        if (selectedBitacora.entries.flora) allEntries.push(...selectedBitacora.entries.flora);
        if (selectedBitacora.entries.general) allEntries.push(...selectedBitacora.entries.general);
        
        // Eliminar duplicados por fecha - mantener la entrada m√°s completa
        const entriesByDate = {};
        allEntries.forEach(entry => {
          const date = entry.date;
          if (!entriesByDate[date] || 
              (entry.tasks && entry.tasks.length > (entriesByDate[date].tasks || '').length)) {
            entriesByDate[date] = entry;
          }
        });
        
        // Filtrar por semana actual
        weekEntries = Object.values(entriesByDate).filter(entry => {
          const entryDate = new Date(entry.date);
          return entryDate >= weekStart && entryDate <= today;
        });
      } else {
        // En otras etapas, usar solo entradas de esa etapa
        weekEntries = getEntries().filter(entry => {
          const entryDate = new Date(entry.date);
          return entryDate >= weekStart && entryDate <= today;
        });
      }

      // Actualizar la UI
      document.getElementById('totalEntries').textContent = weekEntries.length;
      
      // MEJORAR DISPLAY DEL PROMEDIO EMOCIONAL
      const moods = weekEntries.map(e => e.mood).filter(m => m);
      let avgMoodDisplay = '-';
      if (moods.length > 0) {
        const avgMood = moods.reduce((a, b) => a + b, 0) / moods.length;
        const moodLabels = ['üòî', 'üòê', 'üòä', 'ü§©'];
        const moodTexts = ['Dif√≠cil', 'Regular', 'Bueno', 'Excelente'];
        const moodIndex = Math.round(avgMood) - 1;
        avgMoodDisplay = `${moodLabels[moodIndex]} ${moodTexts[moodIndex]} (${avgMood.toFixed(1)})`;
      }
      document.getElementById('averageMood').textContent = avgMoodDisplay;
      
      // CORREGIR CONTEO DE D√çAS DE RIEGO - evitar duplicados
      const uniqueWateredDates = new Set();
      weekEntries.forEach(entry => {
        if (entry.didWater) {
          uniqueWateredDates.add(entry.date);
        }
      });
      document.getElementById('wateredDays').textContent = uniqueWateredDates.size;

      // Timeline emocional mejorado
      const timeline = document.getElementById('emotionTimeline');
      const sortedEntries = weekEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
      timeline.innerHTML = sortedEntries.map(entry => {
        const mood = moodStates.find(m => m.value === entry.mood);
        return `<div class="emotion-dot" 
                     style="background-color: ${mood?.color || '#e2e8f0'}"
                     title="${entry.date} - ${mood?.label || 'Sin estado'} - ${entry.tasks?.substring(0, 30) || 'Sin tareas'}..."></div>`;
      }).join('');

      // Generar resumen con IA si estamos en general y hay datos
      if (selectedStage === 'general' && weekEntries.length > 0) {
        generateAISummary(weekEntries);
      } else if (selectedStage === 'general') {
        // Ocultar resumen IA si no hay datos
        const aiSummary = document.getElementById('aiSummary');
        if (aiSummary) aiSummary.style.display = 'none';
      }

      console.log(`‚úÖ Resumen semanal actualizado para ${selectedStage}: ${weekEntries.length} entradas √∫nicas, ${uniqueWateredDates.size} d√≠as de riego`);
    }

    // ===== SISTEMA DE IA PARA RES√öMENES SEMANALES =====
    
    let currentWeekEntries = [];
    
    async function generateAISummary(weekEntries) {
      currentWeekEntries = weekEntries;
      const aiSummary = document.getElementById('aiSummary');
      const content = document.getElementById('aiSummaryContent');
      
      if (weekEntries.length === 0) {
        aiSummary.style.display = 'none';
        return;
      }
      
      // Mostrar loading
      aiSummary.style.display = 'block';
      content.innerHTML = '<div style="text-align: center; color: #64748b;"><span style="animation: pulse 2s infinite;">üß† Analizando datos...</span></div>';
      
      // Simular procesamiento de IA
      setTimeout(() => {
        const summary = analyzeWeekWithAI(weekEntries);
        content.innerHTML = summary;
      }, 1500);
    }
    
    function analyzeWeekWithAI(entries) {
      // Remover duplicados por fecha antes del an√°lisis
      const uniqueEntriesByDate = {};
      entries.forEach(entry => {
        const date = entry.date;
        if (!uniqueEntriesByDate[date] || 
            (entry.tasks && entry.tasks.length > (uniqueEntriesByDate[date].tasks || '').length)) {
          uniqueEntriesByDate[date] = entry;
        }
      });
      
      const uniqueEntries = Object.values(uniqueEntriesByDate);
      
      const analysis = {
        totalDays: uniqueEntries.length,
        moods: uniqueEntries.map(e => e.mood).filter(Boolean),
        tasks: uniqueEntries.map(e => e.tasks).filter(Boolean),
        issues: uniqueEntries.map(e => e.issues).filter(Boolean),
        notes: uniqueEntries.map(e => e.notes).filter(Boolean),
        watering: uniqueEntries, // Pasar todas las entradas, la funci√≥n filtrar√°
        dates: uniqueEntries.map(e => e.date).sort()
      };
      
      // An√°lisis emocional
      const moodAnalysis = analyzeMoodPatterns(analysis.moods);
      
      // An√°lisis de tareas
      const taskAnalysis = analyzeTaskPatterns(analysis.tasks);
      
      // An√°lisis de problemas
      const issueAnalysis = analyzeIssuePatterns(analysis.issues);
      
      // An√°lisis de riego (ahora recibe todas las entradas)
      const wateringAnalysis = analyzeWateringPatterns(analysis.watering, analysis.totalDays);
      
      // Recomendaciones inteligentes
      const recommendations = generateRecommendations(analysis, moodAnalysis, taskAnalysis, issueAnalysis, wateringAnalysis);
      
      // Generar resumen narrativo
      const narrative = generateNarrative(analysis, moodAnalysis, taskAnalysis, issueAnalysis, wateringAnalysis);
      
      return `
        <div style="margin-bottom: 15px;">
          <strong>üìä An√°lisis de la Semana:</strong><br/>
          ${narrative}
        </div>
        
        <div style="margin-bottom: 15px;">
          <strong>üéØ Puntos Clave:</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            ${moodAnalysis.insights.map(insight => `<li>${insight}</li>`).join('')}
            ${taskAnalysis.insights.map(insight => `<li>${insight}</li>`).join('')}
            ${wateringAnalysis.insights.map(insight => `<li>${insight}</li>`).join('')}
            ${issueAnalysis.insights.map(insight => `<li>${insight}</li>`).join('')}
          </ul>
        </div>
        
        <div style="background: #f0fdf4; padding: 10px; border-radius: 8px; border-left: 3px solid #22c55e;">
          <strong>üí° Recomendaciones IA:</strong><br/>
          ${recommendations.join('<br/>‚Ä¢ ')}
        </div>
      `;
    }
    
    function analyzeMoodPatterns(moods) {
      if (moods.length === 0) return { trend: 'neutral', insights: ['Sin datos emocionales esta semana'] };
      
      const avg = moods.reduce((a, b) => a + b, 0) / moods.length;
      const trend = moods.length > 1 ? (moods[moods.length - 1] > moods[0] ? 'improving' : 'declining') : 'stable';
      
      const insights = [];
      
      if (avg >= 3.5) insights.push('Estado emocional excelente esta semana üòä');
      else if (avg >= 2.5) insights.push('Estado emocional positivo en general üåø');
      else if (avg >= 2) insights.push('Estado emocional variable, con altibajos ‚ö†Ô∏è');
      else insights.push('Semana challenging emocionalmente üòî');
      
      if (trend === 'improving') insights.push('Tendencia emocional al alza üìà');
      else if (trend === 'declining') insights.push('Tendencia emocional a la baja üìâ');
      
      const moodCounts = [1,2,3,4].map(mood => moods.filter(m => m === mood).length);
      const dominantMood = moodCounts.indexOf(Math.max(...moodCounts)) + 1;
      
      const moodLabels = ['d√≠as dif√≠ciles', 'd√≠as regulares', 'd√≠as buenos', 'd√≠as excelentes'];
      insights.push(`Predominaron los ${moodLabels[dominantMood - 1]}`);
      
      return { avg, trend, insights, dominantMood };
    }
    
    function analyzeTaskPatterns(tasks) {
      if (tasks.length === 0) return { insights: ['No se registraron tareas esta semana'] };
      
      const insights = [];
      const allTasks = tasks.join(' ').toLowerCase();
      
      // Detectar patrones en las tareas
      const patterns = {
        riego: ['riego', 'regar', 'agua', 'hidratar'],
        poda: ['poda', 'podar', 'cortar', 'trim'],
        fertilizante: ['fertilizar', 'nutriente', 'abono', 'ferti'],
        entrenamiento: ['doblar', 'lst', 'scrog', 'entrenar', 'guiar'],
        limpieza: ['limpiar', 'aspirar', 'ordenar', 'mantener'],
        observacion: ['revisar', 'observar', 'ver', 'check', 'inspeccionar']
      };
      
      const taskFrequency = {};
      Object.keys(patterns).forEach(category => {
        const count = patterns[category].reduce((acc, keyword) => 
          acc + (allTasks.split(keyword).length - 1), 0);
        if (count > 0) taskFrequency[category] = count;
      });
      
      const topTasks = Object.entries(taskFrequency)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
      
      if (topTasks.length > 0) {
        insights.push(`Actividades principales: ${topTasks.map(([task, _]) => 
          task.charAt(0).toUpperCase() + task.slice(1)).join(', ')}`);
      }
      
      insights.push(`Registraste actividades en ${tasks.length} d√≠as`);
      
      if (taskFrequency.riego > 0) insights.push('Buen seguimiento de riego üíß');
      if (taskFrequency.poda > 0) insights.push('Realizaste trabajos de poda ‚úÇÔ∏è');
      if (taskFrequency.observacion > 0) insights.push('Excelente observaci√≥n de las plantas üëÄ');
      
      return { insights, taskFrequency, topTasks };
    }
    
    function analyzeIssuePatterns(issues) {
      if (issues.length === 0) return { insights: ['No se reportaron problemas esta semana ‚úÖ'] };
      
      const insights = [];
      const allIssues = issues.join(' ').toLowerCase();
      
      const problemPatterns = {
        plagas: ['plaga', 'insecto', 'ara√±a', 'pulgon', 'mosca', 'trip'],
        hongos: ['hongo', 'moho', 'botrytis', 'oidio', 'roya'],
        nutrientes: ['amarill', 'quema', 'deficiencia', 'exceso', 'nutriente'],
        riego: ['seca', 'marchita', 'riego', 'agua'],
        ambiente: ['temperatura', 'humedad', 'ventilacion', 'calor', 'frio']
      };
      
      const problemCount = {};
      Object.keys(problemPatterns).forEach(category => {
        const count = problemPatterns[category].reduce((acc, keyword) => 
          acc + (allIssues.split(keyword).length - 1), 0);
        if (count > 0) problemCount[category] = count;
      });
      
      if (Object.keys(problemCount).length > 0) {
        const mainProblem = Object.entries(problemCount)
          .sort((a, b) => b[1] - a[1])[0][0];
        insights.push(`Problema principal: ${mainProblem} üö®`);
      }
      
      insights.push(`Se reportaron problemas en ${issues.length} d√≠as`);
      
      return { insights, problemCount };
    }
    
    function analyzeWateringPatterns(watering, totalDays) {
      // Contar d√≠as √∫nicos de riego (evitar duplicados por fecha)
      const uniqueWateringDates = new Set();
      const wateringEntries = [];
      
      watering.forEach(entry => {
        if (entry.didWater && !uniqueWateringDates.has(entry.date)) {
          uniqueWateringDates.add(entry.date);
          wateringEntries.push(entry);
        }
      });
      
      const wateringDays = uniqueWateringDates.size;
      const wateringRatio = totalDays > 0 ? wateringDays / totalDays : 0;
      
      const insights = [];
      
      if (wateringDays === 0) {
        insights.push('No se registraron riegos esta semana üèúÔ∏è');
      } else if (wateringRatio >= 0.8) {
        insights.push('Excelente consistencia en el riego üíß');
      } else if (wateringRatio >= 0.5) {
        insights.push('Buen patr√≥n de riego en general üåä');
      } else if (wateringRatio >= 0.3) {
        insights.push('Riego moderado esta semana üíß');
      } else {
        insights.push('Pocos d√≠as de riego registrados üèúÔ∏è');
      }
      
      // Analizar nutrientes si est√°n disponibles
      const withNutrients = wateringEntries.filter(w => w.nutrients && w.nutrients.trim()).length;
      if (withNutrients > 0) {
        insights.push(`Uso de nutrientes en ${withNutrients} de ${wateringDays} riegos üß™`);
      }
      
      // Analizar pH si est√° disponible
      const withPh = wateringEntries.filter(w => w.ph && w.ph.trim()).length;
      if (withPh > 0) {
        const phValues = wateringEntries.map(w => parseFloat(w.ph)).filter(ph => !isNaN(ph) && ph > 0);
        if (phValues.length > 0) {
          const avgPh = phValues.reduce((a, b) => a + b, 0) / phValues.length;
          if (avgPh >= 6.0 && avgPh <= 7.0) {
            insights.push(`pH promedio excelente: ${avgPh.toFixed(1)} üéØ`);
          } else if (avgPh >= 5.5 && avgPh <= 7.5) {
            insights.push(`pH promedio aceptable: ${avgPh.toFixed(1)} ‚ö†Ô∏è`);
          } else {
            insights.push(`pH promedio fuera de rango: ${avgPh.toFixed(1)} üö®`);
          }
        }
      }
      
      return { insights, wateringRatio, wateringDays, uniqueWateringDates: uniqueWateringDates.size };
    }
    
    function generateRecommendations(analysis, moodAnalysis, taskAnalysis, issueAnalysis, wateringAnalysis) {
      const recommendations = [];
      
      // Recomendaciones basadas en el estado emocional
      if (moodAnalysis.avg < 2.5) {
        recommendations.push('üíÜ‚Äç‚ôÄÔ∏è Considera tomarte m√°s tiempo para disfrutar el proceso de cultivo');
        recommendations.push('üìö Quiz√°s revisar t√©cnicas que puedan simplificar tu rutina');
      } else if (moodAnalysis.avg >= 3.5) {
        recommendations.push('üéâ ¬°Excelente semana! Mant√©n esta energ√≠a positiva');
        recommendations.push('üìà Considera documentar qu√© estrategias est√°n funcionando mejor');
      }
      
      // Recomendaciones de riego
      if (wateringAnalysis.wateringRatio < 0.3) {
        recommendations.push('üíß Considera establecer un cronograma de riego m√°s consistente');
      } else if (wateringAnalysis.wateringRatio > 0.8) {
        recommendations.push('‚úÖ Excelente disciplina de riego, sigue as√≠');
      }
      
      // Recomendaciones de tareas
      if (taskAnalysis.taskFrequency && taskAnalysis.taskFrequency.observacion > 0) {
        recommendations.push('üëÄ Tu atenci√≥n al detalle es excelente, sigue observando');
      } else {
        recommendations.push('üîç Intenta dedicar m√°s tiempo a observar detalles de las plantas');
      }
      
      // Recomendaciones de problemas
      if (issueAnalysis.problemCount && Object.keys(issueAnalysis.problemCount).length > 0) {
        recommendations.push('üõ°Ô∏è Considera medidas preventivas para los problemas detectados');
        recommendations.push('üìñ Investigar sobre el manejo espec√≠fico de estos problemas');
      } else {
        recommendations.push('üåü ¬°Sin problemas reportados! Excelente manejo preventivo');
      }
      
      // Recomendaci√≥n general
      recommendations.push('üìä Sigue registrando datos para an√°lisis m√°s precisos');
      
      return recommendations;
    }
    
    function generateNarrative(analysis, moodAnalysis, taskAnalysis, issueAnalysis, wateringAnalysis) {
      const moodDescriptions = {
        1: 'una semana desafiante',
        2: 'una semana con altibajos', 
        3: 'una semana positiva',
        4: 'una semana excelente'
      };
      
      const moodDesc = moodDescriptions[Math.round(moodAnalysis.avg)] || 'una semana interesante';
      
      let narrative = `Esta fue ${moodDesc} con ${analysis.totalDays} d√≠as de registros. `;
      
      if (wateringAnalysis.wateringDays > 0) {
        narrative += `Regaste en ${wateringAnalysis.wateringDays} ocasiones. `;
      }
      
      if (taskAnalysis.topTasks && taskAnalysis.topTasks.length > 0) {
        narrative += `Te enfocaste principalmente en ${taskAnalysis.topTasks[0][0]}. `;
      }
      
      if (issueAnalysis.problemCount && Object.keys(issueAnalysis.problemCount).length > 0) {
        narrative += `Detectaste algunos problemas que requerir√°n atenci√≥n. `;
      } else {
        narrative += `No reportaste problemas significativos. `;
      }
      
      if (moodAnalysis.trend === 'improving') {
        narrative += `La tendencia emocional fue al alza, ¬°buen indicador! `;
      } else if (moodAnalysis.trend === 'declining') {
        narrative += `Hubo algunos desaf√≠os hacia el final de la semana. `;
      }
      
      return narrative;
    }
    
    function regenerateAISummary() {
      if (currentWeekEntries.length > 0) {
        generateAISummary(currentWeekEntries);
      }
    }

    function renderHistory() {
      const entries = getEntries().sort((a,b) => new Date(b.date) - new Date(a.date));
      const container = document.getElementById('history');
      container.innerHTML = '';
      const floraStart = selectedBitacora?.floraStart;

      entries.forEach(e => {
        let diaFlora = '';
        if (selectedStage === 'flora' && floraStart) {
          const start = new Date(floraStart);
          const actual = new Date(e.date);
          const diff = Math.floor((actual - start) / (1000 * 60 * 60 * 24)) + 1;
          diaFlora = ` ‚Äî D√≠a ${diff} de flora`;
        }

        const moodEmoji = moodStates.find(m => m.value === e.mood)?.icon || '';
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `
          <button class="edit-button" onclick="editEntry('${e.date}')">‚úèÔ∏è</button>
          <strong>${e.date}</strong> ‚Äî ${moodEmoji} ${diaFlora}<br/>
          <b>Tareas:</b> ${e.tasks}<br/>
          <b>Riego:</b> ${e.didWater ? 'S√≠' : 'No'} ${e.didWater ? `
            <br/>üíß ${e.waterAmount} | üß¥ ${e.nutrients} | ‚öóÔ∏è pH: ${e.ph} | üìà EC: ${e.ec}` : ''}
          <br/><b>Problemas:</b> ${e.issues}
          <br/><b>Notas:</b> ${e.notes}`;
        container.appendChild(div);
      });
    }

    function renderCalendar() {
      const entries = getEntries();
      const map = {};
      entries.forEach(e => { map[e.date] = e.mood; });

      const container = document.getElementById('calendarVisual');
      container.innerHTML = '<div class="calendar">';
      for (let i = 34; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = d.toISOString().split('T')[0];
        const mood = map[k];
        const cls = mood ? 'm' + mood : '';
        container.innerHTML += `<div class="day ${cls}" title="${k}"></div>`;
      }
      container.innerHTML += '</div>';
    }

    // Funciones de gesti√≥n de bit√°coras
    // Funci√≥n createNewBitacora eliminada - se usa la versi√≥n con Firebase arriba

    function renderBitacoraSelector() {
      const container = document.getElementById('bitacoraSelector');
      
      container.innerHTML = '';
      
      const newButton = document.createElement('button');
      newButton.className = 'bitacora-card';
      newButton.style.backgroundColor = '#e5e7eb';
      newButton.style.color = '#374151';
      newButton.innerHTML = '+ Nueva Bit√°cora';
      newButton.id = 'btnNuevaBitacora';
      newButton.onclick = toggleNewBitacoraForm;
      container.appendChild(newButton);
      
      userBitacoras.forEach(bitacora => {
        const div = document.createElement('div');
        div.className = `bitacora-card ${bitacora.id === selectedBitacora?.id ? 'active' : ''}`;
        div.style.backgroundColor = bitacora.color;
        div.style.color = '#fff';
        
        // Contenedor para el nombre y estado de visibilidad
        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `
          ${bitacora.name}
          <span class="visibility-indicator" title="${bitacora.isPublic ? 'P√∫blica: Cualquiera con el enlace puede ver y compartir esta bit√°cora.' : 'Privada: Solo t√∫ puedes ver esta bit√°cora.'}">
            ${bitacora.isPublic ? 'üåê' : 'üîí'}
          </span>
        `;
        div.appendChild(nameDiv);
        
        // Contenedor para los botones de acci√≥n
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'bitacora-actions';
        
        // Bot√≥n de editar
        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn edit-btn';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditBitacoraModal(bitacora);
        };
        
        // Bot√≥n de eliminar
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-btn delete-btn';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm('¬øEst√°s seguro de que quieres eliminar esta bit√°cora?')) {
            deleteBitacora(bitacora.id);
          }
        };
        
        // Bot√≥n de compartir
        const shareBtn = document.createElement('button');
        shareBtn.className = 'action-btn share-btn';
        shareBtn.innerHTML = 'üì§';
        shareBtn.onclick = (e) => {
          e.stopPropagation();
          if (!bitacora.isPublic) {
            alert('Esta bit√°cora es privada. C√°mbiala a p√∫blica para poder compartirla.');
            return;
          }
          shareBitacora(bitacora);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        actionsDiv.appendChild(shareBtn);
        div.appendChild(actionsDiv);
        
        div.onclick = () => selectBitacora(bitacora.id);
        container.appendChild(div);
      });
    }

    function showNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      form.classList.add('active');
      document.getElementById('newBitacoraName').value = '';
      renderColorPicker();
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      
      // Limpiar cepas
      cepas = [];
      renderCepasList();
      document.getElementById('cepaNombre').value = '';
      document.getElementById('cepaCantidad').value = 1;
      document.getElementById('cepaTipo').value = 'clon';
      document.getElementById('cepaGerminacion').value = '';
      document.getElementById('semillaFields').style.display = 'none';
      
      // Limpiar tipo de cultivo
      document.getElementById('tipoCultivo').value = '';
      document.getElementById('interiorFields').style.display = 'none';
      document.getElementById('numCarpas').value = 0;
      document.getElementById('soloSala').checked = false;
      document.getElementById('carpasList').innerHTML = '';
      
      // Limpiar equipamiento interior
      document.getElementById('lamparasVege').value = 0;
      document.getElementById('wattsVege').value = '';
      document.getElementById('lamparasFlora').value = 0;
      document.getElementById('wattsFlora').value = '';
      document.getElementById('ventiladores').value = 0;
      document.getElementById('pulgadasVentilador').value = '';
      
      // Limpiar extractores
      extractores = [];
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      
      document.getElementById('filtroAire').value = 'no';
      document.getElementById('aireAcondicionado').value = 'no';
      document.getElementById('frigorias').value = '';
      document.getElementById('frigorias').style.display = 'none';
      
      // Limpiar riego
      document.querySelectorAll('#riegoOptions input[type=checkbox]').forEach(cb => cb.checked = false);
      document.getElementById('detalleRiego').value = '';
      document.getElementById('sustrato').value = '';
      
      // Limpiar luces
      tipoLuz = '';
      luces = [];
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
    }

    function renderColorPicker() {
      const colorPicker = document.getElementById('colorPicker');
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option" style="background-color: ${color}" onclick="selectColor(this)"></div>
      `).join('');
    }

    function selectColor(element) {
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
    }

    let cepas = [];
    function addCepa() {
      const nombre = document.getElementById('cepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('cepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('cepaTipo').value;
      const germinacion = document.getElementById('cepaGerminacion').value;
      
      if (!nombre) return;
      
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      
      cepas.push(cepa);
      renderCepasList();
      document.getElementById('cepaNombre').value = '';
      document.getElementById('cepaCantidad').value = 1;
      document.getElementById('cepaTipo').value = 'clon';
      document.getElementById('cepaGerminacion').value = '';
      document.getElementById('semillaFields').style.display = 'none';
      document.getElementById('cepaNombre').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function removeCepa(index) {
      cepas.splice(index, 1);
      renderCepasList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function renderCepasList() {
      const list = document.getElementById('cepasList');
      list.innerHTML = '';
      cepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo})`;
        if (cepa.germinacion) {
          info += ` - Germinaci√≥n: ${cepa.germinacion}`;
        }
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeCepa(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    // Funciones para extractores
    function addExtractor() {
      const cantidad = parseInt(document.getElementById('extractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('extractorPulgadas').value.trim();
      
      if (!pulgadas) return;
      
      extractores.push({ cantidad, pulgadas });
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      document.getElementById('extractorPulgadas').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function removeExtractor(index) {
      extractores.splice(index, 1);
      renderExtractoresList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function renderExtractoresList() {
      const list = document.getElementById('extractoresList');
      list.innerHTML = '';
      extractores.forEach((extractor, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${extractor.cantidad} de ${extractor.pulgadas}"</span> <button class='extractor-remove' onclick='removeExtractor(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    function selectBitacora(id) {
      selectedBitacora = userBitacoras.find(b => b.id === id);
      
      if (selectedBitacora) {
        // Inicializar variables globales con datos de la bit√°cora
        cepas = selectedBitacora.cepas || [];
        extractores = selectedBitacora.extractores || [];
        luces = selectedBitacora.luces || [];
        tipoLuz = selectedBitacora.tipoLuz || '';
        
        document.getElementById('mainContent').style.display = 'block';
        renderBitacoraSelector();
        setStage('vege');
        renderMoodButtons();
        renderHistory();
        renderCalendar();
        updateWeeklySummary();
        
        // Actualizar indicador de problemas
        updateProblemsIndicator();
        updateProblemsButtonIndicator();
      }
    }

    // Funciones de estado y renderizado
    function setStage(stage) {
      selectedStage = stage;
      document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('stage-selected'));
      document.getElementById('btn-' + stage).classList.add('stage-selected');
      
      
      // Mostrar/ocultar elementos seg√∫n la etapa
      const floraStartContainer = document.getElementById('floraStartContainer');
      const bitacoraInfo = document.getElementById('bitacoraInfo');
      const problemsSection = document.getElementById('problemsSection');
      const entryForm = document.getElementById('entryForm');
      
      floraStartContainer.style.display = stage === 'flora' ? 'block' : 'none';
      
      if (stage === 'general') {
        bitacoraInfo.style.display = 'block';
        problemsSection.style.display = 'none';
        if (entryForm) entryForm.style.display = 'none';
        renderBitacoraInfo();
      } else if (stage === 'problems') {
        console.log('üö® Mostrando secci√≥n de problemas');
        bitacoraInfo.style.display = 'none';
        if (problemsSection) {
          problemsSection.style.display = 'block';
          console.log('‚úÖ problemsSection mostrada');
        } else {
          console.error('‚ùå problemsSection no encontrada');
        }
        if (entryForm) entryForm.style.display = 'none';
        renderProblemsSection();
      } else {
        bitacoraInfo.style.display = 'none';
        problemsSection.style.display = 'none';
        if (entryForm) entryForm.style.display = 'block';
      }
      
      renderHistory();
      renderCalendar();
      updateWeeklySummary();
    }

    function setMood(m) {
      selectedMood = m;
      renderMoodButtons();
    }

    function renderMoodButtons() {
      const div = document.getElementById('moodOptions');
      div.innerHTML = '';
      moodStates.forEach(state => {
        const span = document.createElement('span');
        span.className = 'mood-btn' + (selectedMood === state.value ? ' mood-selected' : '');
        span.innerText = `${state.icon} ${state.label}`;
        span.onclick = () => setMood(state.value);
        div.appendChild(span);
      });
    }

    function setWater(val) {
      didWater = val;
      document.getElementById('waterDetails').style.display = val ? 'block' : 'none';
    }

    async function setFloraStart() {
      if (selectedBitacora && currentUser) {
        selectedBitacora.floraStart = document.getElementById('floraStart').value;
        const index = userBitacoras.findIndex(b => b.id === selectedBitacora.id);
        if (index !== -1) {
          userBitacoras[index] = selectedBitacora;
          
          // Guardar en Firebase
          try {
            await saveBitacoraToFirestore(selectedBitacora);
          } catch (error) {
            console.error('Error al guardar fecha de floraci√≥n:', error);
          }
        }
      }
    }

    // Funci√≥n saveEntry eliminada - se usa la versi√≥n con Firebase arriba

    let editingDate = null;

    function editEntry(date) {
      editingDate = date;
      const modal = document.getElementById('editModal');
      modal.style.display = 'block';
      
      document.getElementById('editPassword').value = '';
      document.getElementById('editForm').style.display = 'none';
    }

    function verifyEditPassword() {
      const password = document.getElementById('editPassword').value;
      if (password === 'FUCK I MISS') {
        document.getElementById('editForm').style.display = 'block';
        loadEntryDataForEditing(editingDate);
      } else {
        alert('Contrase√±a incorrecta');
      }
    }

    function loadEntryDataForEditing(date) {
      if (!selectedBitacora || !date) return;
      
      const entries = selectedBitacora.entries[selectedStage] || [];
      const entry = entries.find(e => e.date === date);
      
      if (!entry) {
        alert('No se encontr√≥ la entrada para editar');
        return;
      }

      // Inicializar variables de edici√≥n con los datos actuales
      editSelectedMood = entry.mood;
      editDidWater = entry.didWater;

      // Generar el formulario de edici√≥n con los datos actuales
      const editForm = document.getElementById('editForm');
      editForm.innerHTML = `
        <div style="margin-bottom: 10px;">
          <label>Fecha:</label>
          <input type="date" id="editDate" value="${entry.date}" />
        </div>
        
        <div style="margin-bottom: 10px;">
          <label>Estado emocional:</label>
          <div id="editMoodOptions">
            ${moodStates.map(state => `
              <span class="mood-btn ${entry.mood === state.value ? 'mood-selected' : ''}" 
                    onclick="setEditMood(${state.value})" 
                    data-mood="${state.value}">
                ${state.icon} ${state.label}
              </span>
            `).join('')}
          </div>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label>Tareas realizadas:</label>
          <textarea id="editTasks" style="width: 100%; margin: 5px 0;">${entry.tasks || ''}</textarea>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label>¬øRegaste hoy?</label><br/>
          <button type="button" onclick="setEditWater(true)" 
                  style="background: ${entry.didWater ? '#22c55e' : '#e5e7eb'}; color: ${entry.didWater ? 'white' : 'black'};">
            üíß S√≠
          </button>
          <button type="button" onclick="setEditWater(false)" 
                  style="background: ${!entry.didWater ? '#ef4444' : '#e5e7eb'}; color: ${!entry.didWater ? 'white' : 'black'};">
            ‚ùå No
          </button>
        </div>
        
        <div id="editWaterDetails" style="display: ${entry.didWater ? 'block' : 'none'}; margin-bottom: 10px;">
          <input type="text" id="editWaterAmount" placeholder="Cantidad de agua (L o ml)" value="${entry.waterAmount || ''}" />
          <input type="text" id="editNutrients" placeholder="Nutrientes utilizados" value="${entry.nutrients || ''}" />
          <input type="text" id="editPh" placeholder="pH del agua" value="${entry.ph || ''}" />
          <input type="text" id="editEc" placeholder="EC del agua" value="${entry.ec || ''}" />
        </div>
        
        <div style="margin-bottom: 10px;">
          <label>Problemas o anomal√≠as:</label>
          <textarea id="editIssues" style="width: 100%; margin: 5px 0;">${entry.issues || ''}</textarea>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label>Notas o reflexiones:</label>
          <textarea id="editNotes" style="width: 100%; margin: 5px 0;">${entry.notes || ''}</textarea>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeEditModal()" style="background: #6b7280;">Cancelar</button>
          <button onclick="saveEditedEntry()" style="background: #22c55e;">Guardar Cambios</button>
        </div>
      `;
    }

    let editSelectedMood = null;
    let editDidWater = false;

    function setEditMood(mood) {
      editSelectedMood = mood;
      document.querySelectorAll('#editMoodOptions .mood-btn').forEach(btn => {
        btn.classList.remove('mood-selected');
        if (parseInt(btn.dataset.mood) === mood) {
          btn.classList.add('mood-selected');
        }
      });
    }

    function setEditWater(val) {
      editDidWater = val;
      document.getElementById('editWaterDetails').style.display = val ? 'block' : 'none';
      
      // Actualizar estilos de botones
      const siBtn = document.querySelector('[onclick="setEditWater(true)"]');
      const noBtn = document.querySelector('[onclick="setEditWater(false)"]');
      
      if (val) {
        siBtn.style.background = '#22c55e';
        siBtn.style.color = 'white';
        noBtn.style.background = '#e5e7eb';
        noBtn.style.color = 'black';
      } else {
        siBtn.style.background = '#e5e7eb';
        siBtn.style.color = 'black';
        noBtn.style.background = '#ef4444';
        noBtn.style.color = 'white';
      }
    }

    async function saveEditedEntry() {
      if (!selectedBitacora || !editingDate) {
        alert('Error: No hay bit√°cora seleccionada o fecha de edici√≥n');
        return;
      }

      // Verificaci√≥n de seguridad adicional
      if (!userBitacoras || userBitacoras.length === 0) {
        alert('Error cr√≠tico: No hay datos de bit√°coras cargadas. No se puede continuar.');
        return;
      }
      
      const newDate = document.getElementById('editDate').value;
      const tasks = document.getElementById('editTasks').value;
      const issues = document.getElementById('editIssues').value;
      const notes = document.getElementById('editNotes').value;
      const waterAmount = document.getElementById('editWaterAmount').value;
      const nutrients = document.getElementById('editNutrients').value;
      const ph = document.getElementById('editPh').value;
      const ec = document.getElementById('editEc').value;
      
      if (!newDate || !editSelectedMood) {
        alert('Por favor completa la fecha y el estado emocional.');
        return;
      }

      // Crear respaldo antes de editar
      try {
        const backupData = JSON.stringify({
          timestamp: new Date().toISOString(),
          operation: 'edit_entry',
          selectedBitacora: JSON.parse(JSON.stringify(selectedBitacora)),
          userBitacoras: JSON.parse(JSON.stringify(userBitacoras)),
          editingDate: editingDate,
          newDate: newDate
        });
        localStorage.setItem(`edit_backup_${Date.now()}`, backupData);
        console.log('‚úÖ Respaldo de edici√≥n creado antes de modificar');
      } catch (error) {
        console.error('‚ùå Error creando respaldo:', error);
      }

      const updatedEntry = {
        date: newDate,
        mood: editSelectedMood,
        tasks,
        issues,
        notes,
        didWater: editDidWater,
        waterAmount,
        nutrients,
        ph,
        ec,
        updatedAt: new Date().toISOString()
      };

      try {
        // Verificar que la bit√°cora existe en el array
        const bitacoraIndex = userBitacoras.findIndex(b => b.id === selectedBitacora.id);
        
        if (bitacoraIndex === -1) {
          throw new Error('La bit√°cora seleccionada no se encuentra en la lista');
        }

        // Verificar que la estructura de entradas existe
        if (!userBitacoras[bitacoraIndex].entries) {
          userBitacoras[bitacoraIndex].entries = { vege: [], flora: [], general: [] };
        }
        if (!userBitacoras[bitacoraIndex].entries[selectedStage]) {
          userBitacoras[bitacoraIndex].entries[selectedStage] = [];
        }

        // Crear una copia de las entradas para manipular
        let entries = [...userBitacoras[bitacoraIndex].entries[selectedStage]];
        
        // Remover la entrada antigua
        entries = entries.filter(e => e.date !== editingDate);
        
        // Agregar la entrada actualizada
        entries.push(updatedEntry);
        
        // Actualizar solo esta etapa de entradas
        userBitacoras[bitacoraIndex].entries[selectedStage] = entries;
        selectedBitacora = userBitacoras[bitacoraIndex];
        
        console.log(`‚úÖ Entrada editada: ${editingDate} ‚Üí ${newDate} en etapa ${selectedStage}`);
        console.log(`Total entradas en ${selectedStage}:`, entries.length);
        
        // Guardar en Firestore
        await saveBitacoraToFirestore(selectedBitacora);
        
        // Actualizar UI
        renderHistory();
        renderCalendar();
        updateWeeklySummary();
        
        // Cerrar modal
        closeEditModal();
        
        alert('Entrada actualizada exitosamente');
        
      } catch (error) {
        console.error('‚ùå Error al actualizar entrada:', error);
        alert(`Error al actualizar la entrada: ${error.message}`);
        
        // Intentar restaurar desde el respaldo m√°s reciente
        console.log('Intentando restaurar desde respaldo...');
        try {
          const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('edit_backup_'));
          if (backupKeys.length > 0) {
            const latestBackup = backupKeys.sort().pop();
            const backupData = JSON.parse(localStorage.getItem(latestBackup));
            userBitacoras = backupData.userBitacoras;
            selectedBitacora = backupData.selectedBitacora;
            renderBitacoraSelector();
            selectBitacora(selectedBitacora.id);
            console.log('‚úÖ Datos restaurados desde respaldo');
          }
        } catch (restoreError) {
          console.error('‚ùå Error al restaurar respaldo:', restoreError);
        }
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      // Limpiar variables de edici√≥n
      editingDate = null;
      editSelectedMood = null;
      editDidWater = false;
      document.getElementById('editForm').innerHTML = '';
    }

    function exportData() {
      if (!selectedBitacora) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }
      
      const data = {
        bitacora: selectedBitacora,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `bitacora_${selectedBitacora.name}_export.json`;
      a.click();
    }

    function editCurrentBitacora() {
      if (!selectedBitacora) {
        alert('No hay bit√°cora seleccionada');
        return;
      }
      showEditBitacoraModal(selectedBitacora);
    }

    function loadBitacoraDataToEditForm(bitacora) {
      // Cargar cepas
      editCepas = bitacora.cepas ? [...bitacora.cepas] : [];
      renderEditCepasList();
      
      // Cargar tipo de cultivo
      document.getElementById('editTipoCultivo').value = bitacora.tipoCultivo || '';
      toggleEditInteriorFields();
      
      // Cargar datos de cultivo interior
      if (bitacora.tipoCultivo === 'interior') {
        document.getElementById('editNumCarpas').value = bitacora.numCarpas || 0;
        document.getElementById('editSoloSala').checked = bitacora.soloSala || false;
        toggleEditCarpasFields();
        
        // Cargar carpas
        if (bitacora.carpas && bitacora.carpas.length > 0) {
          setTimeout(() => {
            const carpaInputs = document.querySelectorAll('#editCarpasList input');
            bitacora.carpas.forEach((carpa, index) => {
              if (carpaInputs[index]) {
                carpaInputs[index].value = carpa.metrosCuadrados || '';
              }
            });
          }, 100);
        }
        
        // Cargar l√°mparas
        document.getElementById('editLamparasVege').value = bitacora.lamparasVege || 0;
        document.getElementById('editWattsVege').value = bitacora.wattsVege || '';
        document.getElementById('editLamparasFlora').value = bitacora.lamparasFlora || 0;
        document.getElementById('editWattsFlora').value = bitacora.wattsFlora || '';
        
        // Cargar ventiladores
        document.getElementById('editVentiladores').value = bitacora.ventiladores || 0;
        document.getElementById('editPulgadasVentilador').value = bitacora.pulgadasVentilador || '';
        
        // Cargar extractores
        editExtractores = bitacora.extractores ? [...bitacora.extractores] : [];
        renderEditExtractoresList();
        
        // Cargar filtro de aire
        document.getElementById('editFiltroAire').value = bitacora.filtroAire || 'no';
        
        // Cargar aire acondicionado
        document.getElementById('editAireAcondicionado').value = bitacora.aireAcondicionado || 'no';
        document.getElementById('editFrigorias').value = bitacora.frigorias || '';
        toggleEditFrigorias();
      }
      
      // Cargar tipo de riego
      const riegoCheckboxes = document.querySelectorAll('#editRiegoOptions input[type="checkbox"]');
      riegoCheckboxes.forEach(checkbox => {
        checkbox.checked = bitacora.riegoOptions && bitacora.riegoOptions.includes(checkbox.value);
      });
      document.getElementById('editDetalleRiego').value = bitacora.detalleRiego || '';
      
      // Cargar sustrato
      document.getElementById('editSustrato').value = bitacora.sustrato || '';
    }

    function showEditBitacoraModal(bitacora) {
      const modal = document.getElementById('editBitacoraModal');
      const nameInput = document.getElementById('editBitacoraName');
      const colorPicker = document.getElementById('editColorPicker');
      
      nameInput.value = bitacora.name;
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option ${color === bitacora.color ? 'selected' : ''}" 
             style="background-color: ${color}" 
             onclick="selectEditColor(this)"></div>
      `).join('');

      // Cargar datos existentes de la bit√°cora
      loadBitacoraDataToEditForm(bitacora);

      // Agregar el selector de visibilidad
      const existingVisibility = modal.querySelector('.visibility-selector');
      if (existingVisibility) {
        existingVisibility.remove();
      }
      
      const visibilityDiv = document.createElement('div');
      visibilityDiv.className = 'visibility-selector';
      visibilityDiv.innerHTML = `
        <label>Visibilidad:</label>
        <select id="editBitacoraVisibility">
          <option value="false" ${!bitacora.isPublic ? 'selected' : ''}>Privada</option>
          <option value="true" ${bitacora.isPublic ? 'selected' : ''}>P√∫blica</option>
        </select>
      `;
      modal.querySelector('.edit-bitacora-content').insertBefore(
        visibilityDiv,
        modal.querySelector('.edit-bitacora-content button')
      );
      
      modal.dataset.bitacoraId = bitacora.id;
      modal.style.display = 'block';
    }

    function closeEditBitacoraModal() {
      document.getElementById('editBitacoraModal').style.display = 'none';
    }

    function selectEditColor(element) {
      document.querySelectorAll('#editColorPicker .color-option').forEach(opt => 
        opt.classList.remove('selected')
      );
      element.classList.add('selected');
    }

    async function saveBitacoraEdit() {
      const modal = document.getElementById('editBitacoraModal');
      const bitacoraId = modal.dataset.bitacoraId;
      const newName = document.getElementById('editBitacoraName').value.trim();
      const selectedColor = document.querySelector('#editColorPicker .color-option.selected');
      const isPublic = document.getElementById('editBitacoraVisibility').value === 'true';
      
      if (!newName) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }
      
      const index = userBitacoras.findIndex(b => b.id === bitacoraId);
      
      if (index !== -1) {
        // Verificar si el nuevo nombre ya existe
        if (userBitacoras.some(b => b.id !== bitacoraId && b.name.toLowerCase() === newName.toLowerCase())) {
          alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
          return;
        }
        
        userBitacoras[index].name = newName;
        userBitacoras[index].color = selectedColor.style.backgroundColor;
        userBitacoras[index].isPublic = isPublic;
        
        if (selectedBitacora?.id === bitacoraId) {
          selectedBitacora = userBitacoras[index];
        }
        
        // Guardar en Firebase
        if (currentUser) {
          try {
            await saveBitacoraToFirestore(userBitacoras[index]);
          } catch (error) {
            console.error('Error al guardar cambios en Firebase:', error);
          }
        }
        
        renderBitacoraSelector();
        
        // Si estamos en la secci√≥n general, actualizar la vista
        if (selectedStage === 'general') {
          renderBitacoraInfo();
        }
        
        closeEditBitacoraModal();
      }
    }

    async function deleteBitacora(id) {
      if (!currentUser) return;
      
      try {
        // Eliminar de Firebase
        await db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').doc(id).delete();
        
        // Eliminar de memoria
        userBitacoras = userBitacoras.filter(b => b.id !== id);
        
        if (selectedBitacora?.id === id) {
          selectedBitacora = null;
          document.getElementById('mainContent').style.display = 'none';
        }
        
        renderBitacoraSelector();
      } catch (error) {
        console.error('Error al eliminar bit√°cora:', error);
        alert('Error al eliminar la bit√°cora.');
      }
    }

    function shareBitacora(bitacora) {
      // Crear un objeto con los datos necesarios para compartir
      const shareData = {
        id: bitacora.id,
        name: bitacora.name,
        entries: bitacora.entries
      };
      
      // Convertir a base64 para el link
      const encodedData = btoa(JSON.stringify(shareData));
      const shareUrl = `${window.location.origin}${window.location.pathname}?share=${encodedData}`;
      
      // Crear el mensaje para WhatsApp
      const message = `¬°Mira mi bit√°cora "${bitacora.name}"!\n${shareUrl}`;
      
      // Abrir WhatsApp con el mensaje
      window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    // Inicializaci√≥n
    (function init() {
      renderBitacoraSelector();
      
      // Verificar si hay un link compartido
      const urlParams = new URLSearchParams(window.location.search);
      const sharedData = urlParams.get('share');
      
      if (sharedData) {
        try {
          const decodedData = JSON.parse(atob(sharedData));
          // Crear una nueva bit√°cora con los datos compartidos
          const newBitacora = {
            id: Date.now().toString(),
            name: `${decodedData.name} (Compartida)`,
            color: availableColors[Math.floor(Math.random() * availableColors.length)],
            floraStart: null,
            isPublic: true,
            entries: decodedData.entries
          };
          
          const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
          bitacoras.push(newBitacora);
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
          
          // Limpiar la URL
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Seleccionar la nueva bit√°cora
          selectBitacora(newBitacora.id);
        } catch (error) {
          console.error('Error al procesar datos compartidos:', error);
        }
      } else {
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        if (bitacoras.length > 0) {
          selectBitacora(bitacoras[0].id);
        } else {
          showNewBitacoraForm();
        }
      }
    })();

    // Funciones de respaldo eliminadas - ya no se usan

    function showHelpModal() {
      document.getElementById('helpModal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('helpModal').style.display = 'none';
    }

    // L√≥gica para tipo de luz
    function selectLuz(tipo) {
      tipoLuz = tipo;
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      if (tipo === 'sol') {
        document.getElementById('luzSolBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
      } else if (tipo === 'luz') {
        document.getElementById('luzArtificialBtn').classList.add('selected');
        document.getElementById('luzArtificialFields').style.display = 'block';
      } else if (tipo === 'mixto') {
        document.getElementById('luzMixtoBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
        document.getElementById('luzArtificialFields').style.display = 'block';
      }
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.tipoLuz = tipoLuz;
        autoSave();
      }
    }

    // Funci√≥n para mostrar/ocultar campo de germinaci√≥n
    function toggleGerminacionField() {
      const tipo = document.getElementById('cepaTipo').value;
      const semillaFields = document.getElementById('semillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }

    function addLuz() {
      const nombre = document.getElementById('luzNombre').value.trim();
      const cantidad = parseInt(document.getElementById('luzCantidad').value, 10) || 1;
      const watts = parseInt(document.getElementById('luzWatts').value, 10) || 0;
      if (!nombre || !watts) return;
      luces.push({ nombre, cantidad, watts });
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
      document.getElementById('luzNombre').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function removeLuz(index) {
      luces.splice(index, 1);
      renderLucesList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function renderLucesList() {
      const list = document.getElementById('lucesList');
      list.innerHTML = '';
      luces.forEach((luz, idx) => {
        const div = document.createElement('div');
        div.className = 'luz-item';
        div.innerHTML = `<span>${luz.nombre}</span> <span>x${luz.cantidad}</span> <span>${luz.watts}W</span> <button class='luz-remove' onclick='removeLuz(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    function renderBitacoraInfo() {
      if (!selectedBitacora) return;
      
      const container = document.getElementById('bitacoraInfoContent');
      container.innerHTML = '';
      
      // Verificar si la bit√°cora tiene caracter√≠sticas guardadas
      if (!selectedBitacora.cepas && !selectedBitacora.tipoCultivo) {
        container.innerHTML = '<div class="no-info">Esta bit√°cora no tiene caracter√≠sticas guardadas. Edita la bit√°cora para agregar informaci√≥n.</div>';
        return;
      }
      
      const infoGrid = document.createElement('div');
      infoGrid.className = 'info-grid';
      
      // Secci√≥n de Cepas
      if (selectedBitacora.cepas && selectedBitacora.cepas.length > 0) {
        const cepasSection = document.createElement('div');
        cepasSection.className = 'info-section';
        cepasSection.innerHTML = '<h4>üå± Cepas</h4>';
        selectedBitacora.cepas.forEach(cepa => {
          const item = document.createElement('div');
          item.className = 'info-item';
          let info = `<span class='info-label'>${cepa.nombre}</span> <span class='info-value cepa'>x${cepa.cantidad}</span> <span class='info-value'>(${cepa.tipo}`;
          if (cepa.tipo === 'semilla' && cepa.germinacion) {
            info += `, germinaci√≥n: ${cepa.germinacion}`;
          }
          info += ")</span>";
          item.innerHTML = info;
          cepasSection.appendChild(item);
        });
        infoGrid.appendChild(cepasSection);
      }
      
      // Secci√≥n de Tipo de Cultivo
      if (selectedBitacora.tipoCultivo) {
        const cultivoSection = document.createElement('div');
        cultivoSection.className = 'info-section';
        cultivoSection.innerHTML = '<h4>üè† Tipo de Cultivo</h4>';
        const cultivoItem = document.createElement('div');
        cultivoItem.className = 'info-item';
        const cultivoText = selectedBitacora.tipoCultivo.charAt(0).toUpperCase() + selectedBitacora.tipoCultivo.slice(1);
        cultivoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value ${selectedBitacora.tipoCultivo}">${cultivoText}</span>
        `;
        cultivoSection.appendChild(cultivoItem);
        // Informaci√≥n adicional para cultivo interior/invernadero
        if ((selectedBitacora.tipoCultivo === 'interior' || selectedBitacora.tipoCultivo === 'invernadero')) {
          if (selectedBitacora.numCarpas > 0) {
            const carpasItem = document.createElement('div');
            carpasItem.className = 'info-item';
            let carpasInfo = `${selectedBitacora.numCarpas}`;
            if (selectedBitacora.carpas && selectedBitacora.carpas.length > 0) {
              carpasInfo += ' (' + selectedBitacora.carpas.map((c, i) => `Carpa ${i+1}: ${c.metrosCuadrados} m¬≤`).join(', ') + ')';
            }
            carpasItem.innerHTML = `
              <span class="info-label">Carpas</span>
              <span class="info-value">${carpasInfo}</span>
            `;
            cultivoSection.appendChild(carpasItem);
          }
          if (selectedBitacora.soloSala) {
            const salaItem = document.createElement('div');
            salaItem.className = 'info-item';
            let salaInfo = 'Solo sala';
            if (selectedBitacora.carpas && selectedBitacora.carpas.length === 1) {
              salaInfo += ` (${selectedBitacora.carpas[0].metrosCuadrados} m¬≤)`;
            }
            salaItem.innerHTML = `
              <span class="info-label">Configuraci√≥n</span>
              <span class="info-value">${salaInfo}</span>
            `;
            cultivoSection.appendChild(salaItem);
          }
        }
        infoGrid.appendChild(cultivoSection);
      }
      // Secci√≥n de Extractores
      if (selectedBitacora.extractores && selectedBitacora.extractores.length > 0) {
        const extSection = document.createElement('div');
        extSection.className = 'info-section';
        extSection.innerHTML = '<h4>üí® Extractores</h4>';
        selectedBitacora.extractores.forEach((ext, idx) => {
          const extItem = document.createElement('div');
          extItem.className = 'info-item';
          extItem.innerHTML = `<span class='info-label'>Extractor ${idx+1}</span> <span class='info-value'>x${ext.cantidad} de ${ext.pulgadas}"</span>`;
          extSection.appendChild(extItem);
        });
        infoGrid.appendChild(extSection);
      }
      
      // Secci√≥n de Iluminaci√≥n
      if (selectedBitacora.tipoLuz || (selectedBitacora.luces && selectedBitacora.luces.length > 0)) {
        const luzSection = document.createElement('div');
        luzSection.className = 'info-section';
        luzSection.innerHTML = '<h4>üí° Iluminaci√≥n</h4>';
        
        if (selectedBitacora.tipoLuz) {
          const tipoLuzItem = document.createElement('div');
          tipoLuzItem.className = 'info-item';
          let tipoLuzText = '';
          switch (selectedBitacora.tipoLuz) {
            case 'sol': tipoLuzText = '‚òÄÔ∏è Sol'; break;
            case 'luz': tipoLuzText = 'üí° Artificial'; break;
            case 'mixto': tipoLuzText = 'üîÑ Mixto'; break;
          }
          tipoLuzItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value luz">${tipoLuzText}</span>
          `;
          luzSection.appendChild(tipoLuzItem);
        }
        
        if (selectedBitacora.luces && selectedBitacora.luces.length > 0) {
          selectedBitacora.luces.forEach(luz => {
            const luzItem = document.createElement('div');
            luzItem.className = 'info-item';
            luzItem.innerHTML = `
              <span class="info-label">${luz.nombre}</span>
              <span class="info-value">x${luz.cantidad} (${luz.watts}W)</span>
            `;
            luzSection.appendChild(luzItem);
          });
        }
        
        // Informaci√≥n de l√°mparas para cultivo interior
        if (selectedBitacora.tipoCultivo === 'interior') {
          if (selectedBitacora.lamparasVege > 0) {
            const vegeItem = document.createElement('div');
            vegeItem.className = 'info-item';
            vegeItem.innerHTML = `
              <span class="info-label">L√°mparas Vegetaci√≥n</span>
              <span class="info-value">${selectedBitacora.lamparasVege}${selectedBitacora.wattsVege ? ` (${selectedBitacora.wattsVege})` : ''}</span>
            `;
            luzSection.appendChild(vegeItem);
          }
          
          if (selectedBitacora.lamparasFlora > 0) {
            const floraItem = document.createElement('div');
            floraItem.className = 'info-item';
            floraItem.innerHTML = `
              <span class="info-label">L√°mparas Floraci√≥n</span>
              <span class="info-value">${selectedBitacora.lamparasFlora}${selectedBitacora.wattsFlora ? ` (${selectedBitacora.wattsFlora})` : ''}</span>
            `;
            luzSection.appendChild(floraItem);
          }
        }
        
        infoGrid.appendChild(luzSection);
      }
      
      // Secci√≥n de Riego
      if (selectedBitacora.riegoOptions && selectedBitacora.riegoOptions.length > 0) {
        const riegoSection = document.createElement('div');
        riegoSection.className = 'info-section';
        riegoSection.innerHTML = '<h4>üíß Riego</h4>';
        
        selectedBitacora.riegoOptions.forEach(riego => {
          const riegoItem = document.createElement('div');
          riegoItem.className = 'info-item';
          let riegoText = '';
          switch (riego) {
            case 'manual': riegoText = 'üëã Manual'; break;
            case 'goteo': riegoText = 'üíß Goteo'; break;
            case 'hidroponica': riegoText = 'üåä Hidrop√≥nica'; break;
          }
          riegoItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value riego">${riegoText}</span>
          `;
          riegoSection.appendChild(riegoItem);
        });
        
        if (selectedBitacora.detalleRiego) {
          const detalleItem = document.createElement('div');
          detalleItem.className = 'info-item';
          detalleItem.innerHTML = `
            <span class="info-label">Detalles</span>
            <span class="info-value">${selectedBitacora.detalleRiego}</span>
          `;
          riegoSection.appendChild(detalleItem);
        }
        
        infoGrid.appendChild(riegoSection);
      }
      
      // Secci√≥n de Sustrato
      if (selectedBitacora.sustrato) {
        const sustratoSection = document.createElement('div');
        sustratoSection.className = 'info-section';
        sustratoSection.innerHTML = '<h4>üå± Sustrato</h4>';
        
        const sustratoItem = document.createElement('div');
        sustratoItem.className = 'info-item';
        sustratoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value">${selectedBitacora.sustrato}</span>
        `;
        sustratoSection.appendChild(sustratoItem);
        
        infoGrid.appendChild(sustratoSection);
      }
      
      // Secci√≥n de Equipamiento (solo para cultivo interior)
      if (selectedBitacora.tipoCultivo === 'interior') {
        const equipamientoSection = document.createElement('div');
        equipamientoSection.className = 'info-section';
        equipamientoSection.innerHTML = '<h4>‚öôÔ∏è Equipamiento</h4>';
        
        if (selectedBitacora.ventiladores > 0) {
          const ventiladoresItem = document.createElement('div');
          ventiladoresItem.className = 'info-item';
          ventiladoresItem.innerHTML = `
            <span class="info-label">Ventiladores</span>
            <span class="info-value">${selectedBitacora.ventiladores}${selectedBitacora.pulgadasVentilador ? ` (${selectedBitacora.pulgadasVentilador}")` : ''}</span>
          `;
          equipamientoSection.appendChild(ventiladoresItem);
        }
        
        if (selectedBitacora.filtroAire === 'si') {
          const filtroItem = document.createElement('div');
          filtroItem.className = 'info-item';
          filtroItem.innerHTML = `
            <span class="info-label">Filtro de Aire</span>
            <span class="info-value">‚úÖ S√≠</span>
          `;
          equipamientoSection.appendChild(filtroItem);
        }
        
        if (selectedBitacora.aireAcondicionado === 'si') {
          const aireItem = document.createElement('div');
          aireItem.className = 'info-item';
          aireItem.innerHTML = `
            <span class="info-label">Aire Acondicionado</span>
            <span class="info-value">‚úÖ S√≠${selectedBitacora.frigorias ? ` (${selectedBitacora.frigorias})` : ''}</span>
          `;
          equipamientoSection.appendChild(aireItem);
        }
        
        if (equipamientoSection.children.length > 1) { // M√°s de 1 porque incluye el h4
          infoGrid.appendChild(equipamientoSection);
        }
      }
      
      container.appendChild(infoGrid);
    }

    // Funciones de respaldo eliminadas - ya no se usan

    // Funciones auxiliares para el formulario
    function toggleInteriorFields() {
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const interiorFields = document.getElementById('interiorFields');
      interiorFields.style.display = tipoCultivo === 'interior' ? 'block' : 'none';
    }

    function toggleCarpasFields() {
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const carpasList = document.getElementById('carpasList');
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala √∫nica</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleFrigorias() {
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias');
      frigorias.style.display = aireAcondicionado === 'si' ? 'block' : 'none';
    }

    // Funciones para edici√≥n de bit√°cora
    function toggleEditInteriorFields() {
      const tipoCultivo = document.getElementById('editTipoCultivo').value;
      const interiorFields = document.getElementById('editInteriorFields');
      interiorFields.style.display = tipoCultivo === 'interior' ? 'block' : 'none';
    }

    function toggleEditCarpasFields() {
      const numCarpas = parseInt(document.getElementById('editNumCarpas').value) || 0;
      const soloSala = document.getElementById('editSoloSala').checked;
      const carpasList = document.getElementById('editCarpasList');
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala √∫nica</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleEditFrigorias() {
      const aireAcondicionado = document.getElementById('editAireAcondicionado').value;
      const frigorias = document.getElementById('editFrigorias');
      frigorias.style.display = aireAcondicionado === 'si' ? 'block' : 'none';
    }

    // Funciones para edici√≥n de cepas en modal de edici√≥n
    let editCepas = [];
    function addEditCepa() {
      const nombre = document.getElementById('editCepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('editCepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('editCepaTipo').value;
      const germinacion = document.getElementById('editCepaGerminacion').value;
      if (!nombre) return;
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      editCepas.push(cepa);
      renderEditCepasList();
      document.getElementById('editCepaNombre').value = '';
      document.getElementById('editCepaCantidad').value = 1;
      document.getElementById('editCepaTipo').value = 'clon';
      document.getElementById('editCepaGerminacion').value = '';
      document.getElementById('editSemillaFields').style.display = 'none';
    }
    function removeEditCepa(index) {
      editCepas.splice(index, 1);
      renderEditCepasList();
    }
    function renderEditCepasList() {
      const list = document.getElementById('editCepasList');
      list.innerHTML = '';
      editCepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo}`;
        if (cepa.tipo === 'semilla' && cepa.germinacion) {
          info += `, germinaci√≥n: ${cepa.germinacion}`;
        }
        info += ")";
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeEditCepa(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }
    function toggleEditGerminacionField() {
      const tipo = document.getElementById('editCepaTipo').value;
      const semillaFields = document.getElementById('editSemillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }
    // Funciones para extractores en edici√≥n
    let editExtractores = [];
    function addEditExtractor() {
      const cantidad = parseInt(document.getElementById('editExtractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('editExtractorPulgadas').value.trim();
      if (!pulgadas) return;
      editExtractores.push({ cantidad, pulgadas });
      renderEditExtractoresList();
      document.getElementById('editExtractorCantidad').value = 1;
      document.getElementById('editExtractorPulgadas').value = '';
    }
    function removeEditExtractor(index) {
      editExtractores.splice(index, 1);
      renderEditExtractoresList();
    }
    function renderEditExtractoresList() {
      const list = document.getElementById('editExtractoresList');
      list.innerHTML = '';
      editExtractores.forEach((ext, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${ext.cantidad} de ${ext.pulgadas}"</span> <button class='extractor-remove' onclick='removeEditExtractor(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    // Modo nocturno
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      const btn = document.getElementById('toggleDarkMode');
      if (body.classList.contains('dark-mode')) {
        btn.textContent = '‚òÄÔ∏è';
        localStorage.setItem('darkMode', '1');
      } else {
        btn.textContent = 'üåô';
        localStorage.setItem('darkMode', '0');
      }
    }
    // Al cargar, aplicar modo guardado
    if (localStorage.getItem('darkMode') === '1') {
      document.body.classList.add('dark-mode');
      document.getElementById('toggleDarkMode').textContent = '‚òÄÔ∏è';
    }

    // Alternar formulario de nueva bit√°cora
    function toggleNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      const btn = document.getElementById('btnNuevaBitacora');
      if (form.style.display === 'block' || form.classList.contains('active')) {
        form.style.display = 'none';
        form.classList.remove('active');
        if (btn) btn.textContent = '+ Nueva Bit√°cora';
      } else {
        form.style.display = 'block';
        form.classList.add('active');
        if (btn) btn.textContent = 'Cerrar';
        showNewBitacoraForm();
      }
    }

    // ========== SISTEMA DE GESTI√ìN DE PROBLEMAS ==========
    
    // Variables globales para problemas
    let currentEditingProblemId = null;
    let allProblems = [];

    // Funciones principales del sistema de problemas
    function showProblemsManager() {
      if (!selectedBitacora) {
        alert('Selecciona una bit√°cora primero');
        return;
      }
      
      loadProblems();
      updateProblemStats();
      renderProblemsList();
      document.getElementById('problemsModal').style.display = 'block';
    }

    function closeProblemsModal() {
      document.getElementById('problemsModal').style.display = 'none';
      resetFilters();
    }

    function closeEditProblemModal() {
      document.getElementById('editProblemModal').style.display = 'none';
      currentEditingProblemId = null;
    }

    // Cargar problemas de la bit√°cora actual
    function loadProblems() {
      if (!selectedBitacora) return;
      
      // Inicializar problemas si no existen
      if (!selectedBitacora.problems) {
        selectedBitacora.problems = [];
      }
      
      allProblems = [...selectedBitacora.problems];
    }

    // Agregar nuevo problema
    function addNewProblem() {
      const title = document.getElementById('newProblemTitle').value.trim();
      const severity = document.getElementById('newProblemSeverity').value;
      const category = document.getElementById('newProblemCategory').value;
      const description = document.getElementById('newProblemDescription').value.trim();
      
      if (!title) {
        alert('Por favor describe el problema');
        return;
      }
      
      const newProblem = {
        id: Date.now().toString(),
        title: title,
        description: description,
        severity: severity,
        category: category,
        status: 'reported',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        solution: '',
        resolvedAt: null
      };
      
      // Agregar a la bit√°cora actual
      if (!selectedBitacora.problems) {
        selectedBitacora.problems = [];
      }
      selectedBitacora.problems.push(newProblem);
      
      // Guardar autom√°ticamente
      if (currentUser) {
        saveBitacoraToFirestore(selectedBitacora).then(() => {
          console.log('‚úÖ Problema guardado en Firebase');
        }).catch(error => {
          console.error('‚ùå Error guardando problema:', error);
        });
      }
      
      // Actualizar vista
      loadProblems();
      updateProblemStats();
      renderProblemsList();
      
      // Si estamos en la secci√≥n de problemas, actualizar tambi√©n
      if (selectedStage === 'problems') {
        updateProblemStatsSection();
        renderProblemsListSection();
      }
      
      // Actualizar indicador del bot√≥n
      updateProblemsButtonIndicator();
      
      // Limpiar formulario
      document.getElementById('newProblemTitle').value = '';
      document.getElementById('newProblemDescription').value = '';
      document.getElementById('newProblemSeverity').value = 'low';
      document.getElementById('newProblemCategory').value = 'pest';
      
      console.log('Problema agregado:', newProblem);
    }

    // Editar problema
    function editProblem(problemId) {
      const problem = allProblems.find(p => p.id === problemId);
      if (!problem) return;
      
      currentEditingProblemId = problemId;
      
      // Llenar formulario de edici√≥n
      document.getElementById('editProblemStatus').value = problem.status;
      document.getElementById('editProblemSeverity').value = problem.severity;
      document.getElementById('editProblemSolution').value = problem.solution || '';
      
      document.getElementById('editProblemModal').style.display = 'block';
    }

    // Guardar edici√≥n de problema
    function saveProblemEdit() {
      if (!currentEditingProblemId) return;
      
      const status = document.getElementById('editProblemStatus').value;
      const severity = document.getElementById('editProblemSeverity').value;
      const solution = document.getElementById('editProblemSolution').value.trim();
      
      // Encontrar problema en la bit√°cora
      const problemIndex = selectedBitacora.problems.findIndex(p => p.id === currentEditingProblemId);
      if (problemIndex === -1) return;
      
      const oldStatus = selectedBitacora.problems[problemIndex].status;
      
      // Actualizar problema
      selectedBitacora.problems[problemIndex].status = status;
      selectedBitacora.problems[problemIndex].severity = severity;
      selectedBitacora.problems[problemIndex].solution = solution;
      selectedBitacora.problems[problemIndex].updatedAt = new Date().toISOString();
      
      // Si se marca como resuelto y antes no lo estaba
      if (status === 'resolved' && oldStatus !== 'resolved') {
        selectedBitacora.problems[problemIndex].resolvedAt = new Date().toISOString();
      }
      // Si se desmarca como resuelto
      else if (status !== 'resolved' && oldStatus === 'resolved') {
        selectedBitacora.problems[problemIndex].resolvedAt = null;
      }
      
      // Guardar autom√°ticamente
      if (currentUser) {
        saveBitacoraToFirestore(selectedBitacora).then(() => {
          console.log('‚úÖ Problema actualizado en Firebase');
        }).catch(error => {
          console.error('‚ùå Error actualizando problema:', error);
        });
      }
      
      // Actualizar vista
      loadProblems();
      updateProblemStats();
      renderProblemsList();
      
      // Si estamos en la secci√≥n de problemas, actualizar tambi√©n
      if (selectedStage === 'problems') {
        updateProblemStatsSection();
        renderProblemsListSection();
      }
      
      // Actualizar indicador del bot√≥n
      updateProblemsButtonIndicator();
      
      closeEditProblemModal();
      
      console.log('Problema actualizado:', selectedBitacora.problems[problemIndex]);
    }

    // Eliminar problema
    function deleteProblem(problemId) {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar este problema?')) return;
      
      const problemIndex = selectedBitacora.problems.findIndex(p => p.id === problemId);
      if (problemIndex === -1) return;
      
      selectedBitacora.problems.splice(problemIndex, 1);
      
      // Guardar autom√°ticamente
      if (currentUser) {
        saveBitacoraToFirestore(selectedBitacora).then(() => {
          console.log('‚úÖ Problema eliminado en Firebase');
        }).catch(error => {
          console.error('‚ùå Error eliminando problema:', error);
        });
      }
      
      // Actualizar vista
      loadProblems();
      updateProblemStats();
      renderProblemsList();
      
      // Si estamos en la secci√≥n de problemas, actualizar tambi√©n
      if (selectedStage === 'problems') {
        updateProblemStatsSection();
        renderProblemsListSection();
      }
      
      // Actualizar indicador del bot√≥n
      updateProblemsButtonIndicator();
      
      console.log('Problema eliminado');
    }

    // Actualizar estad√≠sticas
    function updateProblemStats() {
      const active = allProblems.filter(p => p.status !== 'resolved' && p.status !== 'unresolved').length;
      const critical = allProblems.filter(p => p.severity === 'high' && p.status !== 'resolved').length;
      const resolved = allProblems.filter(p => p.status === 'resolved').length;
      
      // Calcular tiempo promedio de resoluci√≥n
      const resolvedProblems = allProblems.filter(p => p.status === 'resolved' && p.resolvedAt && p.createdAt);
      let avgTime = 0;
      
      if (resolvedProblems.length > 0) {
        const totalHours = resolvedProblems.reduce((sum, problem) => {
          const created = new Date(problem.createdAt);
          const resolved = new Date(problem.resolvedAt);
          const hours = (resolved - created) / (1000 * 60 * 60);
          return sum + hours;
        }, 0);
        avgTime = Math.round(totalHours / resolvedProblems.length);
      }
      
      const activeEl = document.getElementById('problemsActive');
      const criticalEl = document.getElementById('problemsCritical');
      const resolvedEl = document.getElementById('problemsResolved');
      const avgTimeEl = document.getElementById('avgResolutionTime');
      
      if (activeEl) activeEl.textContent = active;
      if (criticalEl) criticalEl.textContent = critical;
      if (resolvedEl) resolvedEl.textContent = resolved;
      if (avgTimeEl) avgTimeEl.textContent = avgTime + 'h';
    }

    // Renderizar lista de problemas
    function renderProblemsList() {
      const container = document.getElementById('problemsList');
      if (!container) return; // Elemento no existe, salir silenciosamente
      
      container.innerHTML = '';
      
      if (allProblems.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No hay problemas reportados üéâ</div>';
        return;
      }
      
      // Aplicar filtros
      let filteredProblems = [...allProblems];
      
      const statusFilterEl = document.getElementById('filterStatus');
      const severityFilterEl = document.getElementById('filterSeverity');
      const categoryFilterEl = document.getElementById('filterCategory');
      
      const statusFilter = statusFilterEl ? statusFilterEl.value : 'all';
      const severityFilter = severityFilterEl ? severityFilterEl.value : 'all';
      const categoryFilter = categoryFilterEl ? categoryFilterEl.value : 'all';
      
      if (statusFilter !== 'all') {
        if (statusFilter === 'unresolved') {
          filteredProblems = filteredProblems.filter(p => p.status !== 'resolved');
        } else {
          filteredProblems = filteredProblems.filter(p => p.status === statusFilter);
        }
      }
      
      if (severityFilter !== 'all') {
        filteredProblems = filteredProblems.filter(p => p.severity === severityFilter);
      }
      
      if (categoryFilter !== 'all') {
        filteredProblems = filteredProblems.filter(p => p.category === categoryFilter);
      }
      
      // Ordenar por fecha (m√°s recientes primero)
      filteredProblems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      if (filteredProblems.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No hay problemas que coincidan con los filtros</div>';
        return;
      }
      
      filteredProblems.forEach(problem => {
        const problemCard = createProblemCard(problem);
        container.appendChild(problemCard);
      });
    }

    // Crear tarjeta de problema
    function createProblemCard(problem) {
      const card = document.createElement('div');
      card.className = 'problem-card';
      card.style.cssText = `
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      `;
      
      // Colores seg√∫n gravedad
      const severityColors = {
        high: '#ef4444',
        moderate: '#f59e0b',
        low: '#eab308',
        info: '#22c55e'
      };
      
      // Iconos seg√∫n estado
      const statusIcons = {
        reported: 'üìù',
        'in-progress': '‚è≥',
        resolved: '‚úÖ',
        unresolved: '‚ùå'
      };
      
      // Iconos seg√∫n categor√≠a
      const categoryIcons = {
        pest: 'üêõ',
        nutrition: 'üå±',
        watering: 'üíß',
        environment: 'üå°Ô∏è',
        growth: 'üìè',
        other: '‚ùì'
      };
      
      const createdDate = new Date(problem.createdAt).toLocaleDateString();
      const createdTime = new Date(problem.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      card.innerHTML = `
        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
              <span style="background: ${severityColors[problem.severity]}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">
                ${problem.severity.toUpperCase()}
              </span>
              <span style="background: #f3f4f6; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                ${statusIcons[problem.status]} ${problem.status.replace('-', ' ').toUpperCase()}
              </span>
              <span style="background: #f3f4f6; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                ${categoryIcons[problem.category]}
              </span>
            </div>
            <h4 style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600;">${problem.title}</h4>
            ${problem.description ? `<p style="margin: 0 0 8px 0; color: #6b7280; font-size: 0.9em;">${problem.description}</p>` : ''}
            ${problem.solution ? `<div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin-top: 8px;"><strong>Soluci√≥n:</strong> ${problem.solution}</div>` : ''}
            <div style="font-size: 0.8em; color: #9ca3af; margin-top: 8px;">
              Creado: ${createdDate} ${createdTime}
              ${problem.resolvedAt ? ` ‚Ä¢ Resuelto: ${new Date(problem.resolvedAt).toLocaleDateString()}` : ''}
            </div>
          </div>
          <div style="display: flex; gap: 5px; margin-left: 10px;">
            <button onclick="editProblem('${problem.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
              ‚úèÔ∏è
            </button>
            <button onclick="deleteProblem('${problem.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `;
      
      return card;
    }

    // Filtrar problemas
    function filterProblems() {
      renderProblemsList();
    }

    // Resetear filtros
    function resetFilters() {
      const statusEl = document.getElementById('filterStatus');
      const severityEl = document.getElementById('filterSeverity');
      const categoryEl = document.getElementById('filterCategory');
      
      if (statusEl) statusEl.value = 'all';
      if (severityEl) severityEl.value = 'all';
      if (categoryEl) categoryEl.value = 'all';
    }

    // Funci√≥n para mostrar indicador de problemas activos en la interfaz principal
    function updateProblemsIndicator() {
      if (!selectedBitacora || !selectedBitacora.problems) return;
      
      const activeProblems = selectedBitacora.problems.filter(p => 
        p.status !== 'resolved' && p.status !== 'unresolved'
      ).length;
      
      const criticalProblems = selectedBitacora.problems.filter(p => 
        p.severity === 'high' && p.status !== 'resolved'
      ).length;
      
      // Buscar el bot√≥n de gestionar problemas y actualizar su texto
      const problemButton = document.querySelector('button[onclick="showProblemsManager()"]');
      if (problemButton) {
        let buttonText = 'üö® Gestionar Problemas';
        if (activeProblems > 0) {
          buttonText += ` (${activeProblems})`;
          if (criticalProblems > 0) {
            buttonText += ` üî¥${criticalProblems}`;
            problemButton.style.background = '#fef2f2';
            problemButton.style.borderColor = '#ef4444';
          } else {
            problemButton.style.background = '#fffbeb';
            problemButton.style.borderColor = '#f59e0b';
          }
        } else {
          problemButton.style.background = '';
          problemButton.style.borderColor = '';
        }
        problemButton.textContent = buttonText;
      }
    }

    // ========== FUNCIONES PARA SECCI√ìN DE PROBLEMAS ==========
    
    function renderProblemsSection() {
      if (!selectedBitacora) return;
      
      loadProblems();
      updateProblemStatsSection();
      renderProblemsListSection();
    }

    function updateProblemStatsSection() {
      const active = allProblems.filter(p => p.status !== 'resolved' && p.status !== 'unresolved').length;
      const critical = allProblems.filter(p => p.severity === 'high' && p.status !== 'resolved').length;
      const resolved = allProblems.filter(p => p.status === 'resolved').length;
      
      // Calcular tiempo promedio de resoluci√≥n
      const resolvedProblems = allProblems.filter(p => p.status === 'resolved' && p.resolvedAt && p.createdAt);
      let avgTime = 0;
      
      if (resolvedProblems.length > 0) {
        const totalHours = resolvedProblems.reduce((sum, problem) => {
          const created = new Date(problem.createdAt);
          const resolved = new Date(problem.resolvedAt);
          const hours = (resolved - created) / (1000 * 60 * 60);
          return sum + hours;
        }, 0);
        avgTime = Math.round(totalHours / resolvedProblems.length);
      }
      
      const activeSectionEl = document.getElementById('problemsActiveSection');
      const criticalSectionEl = document.getElementById('problemsCriticalSection');
      const resolvedSectionEl = document.getElementById('problemsResolvedSection');
      const avgTimeSectionEl = document.getElementById('avgResolutionTimeSection');
      
      if (activeSectionEl) activeSectionEl.textContent = active;
      if (criticalSectionEl) criticalSectionEl.textContent = critical;
      if (resolvedSectionEl) resolvedSectionEl.textContent = resolved;
      if (avgTimeSectionEl) avgTimeSectionEl.textContent = avgTime + 'h';
    }

    function renderProblemsListSection() {
      const container = document.getElementById('problemsListSection');
      if (!container) return; // Elemento no existe, salir silenciosamente
      
      container.innerHTML = '';
      
      if (allProblems.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">No hay problemas reportados üéâ<br><small>¬°Tu cultivo est√° en perfecto estado!</small></div>';
        return;
      }
      
      // Aplicar filtros
      let filteredProblems = [...allProblems];
      
      const statusFilterEl = document.getElementById('filterStatusSection');
      const severityFilterEl = document.getElementById('filterSeveritySection');
      const categoryFilterEl = document.getElementById('filterCategorySection');
      
      const statusFilter = statusFilterEl ? statusFilterEl.value : 'all';
      const severityFilter = severityFilterEl ? severityFilterEl.value : 'all';
      const categoryFilter = categoryFilterEl ? categoryFilterEl.value : 'all';
      
      if (statusFilter !== 'all') {
        if (statusFilter === 'unresolved') {
          filteredProblems = filteredProblems.filter(p => p.status !== 'resolved');
        } else {
          filteredProblems = filteredProblems.filter(p => p.status === statusFilter);
        }
      }
      
      if (severityFilter !== 'all') {
        filteredProblems = filteredProblems.filter(p => p.severity === severityFilter);
      }
      
      if (categoryFilter !== 'all') {
        filteredProblems = filteredProblems.filter(p => p.category === categoryFilter);
      }
      
      // Ordenar por fecha (m√°s recientes primero)
      filteredProblems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      if (filteredProblems.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">No hay problemas que coincidan con los filtros</div>';
        return;
      }
      
      filteredProblems.forEach(problem => {
        const problemCard = createProblemCard(problem);
        container.appendChild(problemCard);
      });
    }

    function filterProblemsSection() {
      renderProblemsListSection();
    }

    function addNewProblemFromSection() {
      // Abrir el modal original de problemas
      showProblemsManager();
    }

    // Funci√≥n para actualizar el indicador del bot√≥n de problemas
    function updateProblemsButtonIndicator() {
      if (!selectedBitacora || !selectedBitacora.problems) return;
      
      const activeProblems = selectedBitacora.problems.filter(p => 
        p.status !== 'resolved' && p.status !== 'unresolved'
      ).length;
      
      const criticalProblems = selectedBitacora.problems.filter(p => 
        p.severity === 'high' && p.status !== 'resolved'
      ).length;
      
      // Actualizar el texto del bot√≥n de problemas
      const problemButton = document.getElementById('btn-problems');
      if (problemButton) {
        let buttonText = 'üö® Problemas';
        let buttonStyle = '';
        
        if (activeProblems > 0) {
          buttonText += ` (${activeProblems})`;
          if (criticalProblems > 0) {
            buttonText += ` üî¥`;
            buttonStyle = 'background: #fef2f2; border-color: #ef4444; color: #dc2626;';
          } else {
            buttonStyle = 'background: #fffbeb; border-color: #f59e0b; color: #d97706;';
          }
        }
        
        problemButton.innerHTML = buttonText;
        problemButton.style.cssText = buttonStyle;
      }
    }

    // ========== FIN SISTEMA DE GESTI√ìN DE PROBLEMAS ==========
  </script>
</body>
</html>
